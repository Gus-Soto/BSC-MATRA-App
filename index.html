<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.5">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="es"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Dashboard de KPIs&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.jsdelivr.net/npm/chart.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.368.0/lucide.min.css" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://unpkg.com/lucide@latest"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: 'Inter', sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #e2e8f0; /* Slate 200 - Fondo más oscuro para mayor contraste */</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #111827;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>#login-page {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: url('https://images.unsplash.com/photo-1529369627985-2d9bcf543ea8?q=80&amp;w=2070&amp;auto=format&amp;fit=crop') no-repeat center center fixed;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-size: cover;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.login-overlay {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(0, 0, 0, 0.6);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.75rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 1px solid #e5e7eb;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* Sombra más pronunciada */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: inline-flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 0.5rem 1rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 0.875rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: 500;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: background-color 0.2s;</p>
<p class="p1"><span class="Apple-converted-space">            </span>cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 1px solid transparent;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-primary {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #facc15; /* Matra Yellow */</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #111827; /* Dark text */</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: 700;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-primary:hover {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #eab308;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-secondary {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #374151;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-color: #d1d5db;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-secondary:hover {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #f3f4f6;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.tabs-list button.active {</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom-color: #2563eb;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #2563eb;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: 600;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>dialog {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.75rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 1px solid #e5e7eb;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 90%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-width: 50rem;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>dialog::backdrop {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(0, 0, 0, 0.5);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.collapsible-content {</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-height: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: max-height 0.35s ease-in-out;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.collapsible-content.open {</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-height: 1500px; /* Adjust as needed */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.prose { line-height: 1.7; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.prose strong { font-weight: 600; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.prose ul { list-style-position: inside; padding-left: 0.5rem; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.prose li::marker { content: '•'; color: #4b5563; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes pulse {</p>
<p class="p1"><span class="Apple-converted-space">            </span>50% { opacity: .5; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Custom scrollbar for tabs */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.tabs-list::-webkit-scrollbar {</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 4px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.tabs-list::-webkit-scrollbar-track {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #e2e8f0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.tabs-list::-webkit-scrollbar-thumb {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #94a3b8;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 2px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.tabs-list::-webkit-scrollbar-thumb:hover {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #64748b;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script type="module"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";</p>
<p class="p1"><span class="Apple-converted-space">        </span>import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Your web app's Firebase configuration (provided by user)</p>
<p class="p1"><span class="Apple-converted-space">        </span>const firebaseConfig = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>apiKey: "AIzaSyAt_2O9DN5qblHUaDnlKFkDKP270TezY6g",</p>
<p class="p1"><span class="Apple-converted-space">            </span>authDomain: "bsc-matra-app.firebaseapp.com",</p>
<p class="p1"><span class="Apple-converted-space">            </span>projectId: "bsc-matra-app",</p>
<p class="p1"><span class="Apple-converted-space">            </span>storageBucket: "bsc-matra-app.firebasestorage.app",</p>
<p class="p1"><span class="Apple-converted-space">            </span>messagingSenderId: "742996450855",</p>
<p class="p1"><span class="Apple-converted-space">            </span>appId: "1:742996450855:web:286a28f6acc3d61f63f802"</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Initialize Firebase</p>
<p class="p1"><span class="Apple-converted-space">        </span>const app = initializeApp(firebaseConfig);</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Make db and Firestore functions globally accessible via window object</p>
<p class="p1"><span class="Apple-converted-space">        </span>window.db = getFirestore(app);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>window.firebase_collection = collection;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>window.firebase_doc = doc;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>window.firebase_setDoc = setDoc;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>window.firebase_getDoc = getDoc;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="login-page" class="flex items-center justify-center min-h-screen"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="login-overlay absolute inset-0"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="relative w-full max-w-md p-8 space-y-6 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="login-greeting" class="text-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;form id="login-form" class="space-y-6 mt-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;label for="username" class="text-sm font-medium text-gray-300"&gt;Usuario&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;input id="username" name="username" type="text" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;label for="password" class="text-sm font-medium text-gray-300"&gt;Contraseña&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="relative"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;i data-lucide="eye" class="w-5 h-5"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-yellow-500 bg-gray-700 border-gray-600 focus:ring-yellow-600 rounded"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;label for="remember-me" class="ml-2 block text-sm text-gray-300"&gt;Recordarme&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;p id="login-error" class="text-sm text-red-400 hidden"&gt;Usuario o contraseña incorrectos.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button type="submit" class="w-full btn btn-primary"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>Iniciar Sesión</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/form&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="dashboard-page" class="hidden max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;header class="pb-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h1 class="text-3xl font-bold tracking-tight text-gray-900"&gt;Dashboard de KPIs&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p id="dashboard-subtitle" class="mt-1 text-gray-500"&gt;Mostrando datos para Junio 2025.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex flex-wrap items-center gap-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;select id="year-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;select id="month-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;select id="sector-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="manage-btn" class="btn btn-secondary"&gt;&lt;i data-lucide="settings" class="w-4 h-4 mr-2"&gt;&lt;/i&gt;Administrar&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="export-btn" class="btn btn-secondary"&gt;&lt;i data-lucide="download" class="w-4 h-4 mr-2"&gt;&lt;/i&gt;Exportar&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="logout-btn" class="btn btn-secondary"&gt;&lt;i data-lucide="log-out" class="w-4 h-4 mr-2"&gt;&lt;/i&gt;Cerrar Sesión&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;main&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex flex-col sm:flex-row justify-between items-start sm:items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="tabs-list" class="tabs-list flex flex-nowrap space-x-1 border-b border-gray-200 overflow-x-auto w-full pb-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex items-center space-x-2 mt-4 sm:mt-0 w-full sm:w-auto sm:max-w-xs flex-shrink-0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;i data-lucide="filter" class="w-4 h-4 text-gray-500"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;select id="status-filter-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="todos"&gt;Todos los Estados&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="Bueno"&gt;Filtrar por "Bueno"&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="Regular"&gt;Filtrar por "Regular"&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;option value="Malo"&gt;Filtrar por "Malo"&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="tabs-content" class="mt-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/main&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;dialog id="management-modal"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between items-center mb-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h2 class="text-xl font-semibold text-gray-900"&gt;Administrar Datos de KPIs&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="text-sm text-gray-500 mt-1"&gt;Actualice los valores para el período seleccionado.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="modal-close-btn" class="text-gray-500 hover:text-gray-800"&gt;&lt;i data-lucide="x" class="w-5 h-5"&gt;&lt;/i&gt;&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex gap-4 mb-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;select id="modal-year-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;select id="modal-month-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="modal-form-content" class="max-h-[60vh] overflow-y-auto pr-2 space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-6 flex justify-end space-x-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="modal-cancel-btn" class="btn btn-secondary"&gt;Cancelar&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="modal-save-btn" class="btn btn-primary"&gt;Guardar Cambios&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/dialog&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;template id="kpi-card-template"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="card flex flex-col"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-4 md:p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between items-start"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h3 class="kpi-title text-base font-medium max-w-[70%]"&gt;&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="text-right"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="kpi-achievement"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="kpi-status-badge mt-1 inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full"&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="p-4 md:p-6 pt-0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="kpi-value text-3xl font-bold"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="kpi-meta text-sm text-gray-500 mt-1"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="kpi-trend mt-2 text-xs flex items-center"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="kpi-chart-container mt-auto p-4 md:p-6 pt-0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="text-xs text-gray-500 mb-1"&gt;Tendencia (Últimos 12 meses)&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div style="height: 60px;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;canvas class="kpi-sparkline-chart"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/template&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script type="module"&gt; // Set script type to "module"</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Make Firebase objects available globally as the main script is not a module</p>
<p class="p1"><span class="Apple-converted-space">    </span>// and cannot directly import from the module script.</p>
<p class="p1"><span class="Apple-converted-space">    </span>// This allows the main script to use db, collection, doc, setDoc, getDoc.</p>
<p class="p1"><span class="Apple-converted-space">    </span>const db = window.db;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const firebase_collection = window.firebase_collection;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const firebase_doc = window.firebase_doc;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const firebase_setDoc = window.firebase_setDoc;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const firebase_getDoc = window.firebase_getDoc;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>document.addEventListener('DOMContentLoaded', async () =&gt; { // Made async</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Initialize Lucide icons</p>
<p class="p1"><span class="Apple-converted-space">        </span>lucide.createIcons();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// User Database (Simplified - consider Firebase Authentication for real apps)</p>
<p class="p1"><span class="Apple-converted-space">        </span>const users = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>"EstelaVillalobos": { password: "estela@2025", level: "write", firstName: "Estela" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>"HugoVargas": { password: "Hugo@2025", level: "read", firstName: "Hugo" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>"CarlosCalderon": { password: "Carlos@2025", level: "read", firstName: "Carlos" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>"GustavoSoto": { password: "Gustavo@2025", level: "read", firstName: "Gustavo" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>"FranciscoRamirez": { password: "Francisco@2025", level: "read", firstName: "Francisco" }</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const motivationalQuotes = [</p>
<p class="p1"><span class="Apple-converted-space">            </span>"El éxito es la suma de pequeños esfuerzos repetidos día tras día.",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"Cree en ti mismo y todo lo que eres. Sé consciente de que hay algo dentro de ti que es más grande que cualquier obstáculo.",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"El único lugar donde el éxito viene antes que el trabajo es en el diccionario.",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"No esperes. El momento nunca será el adecuado.",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"La mejor manera de predecir el futuro es crearlo.",</p>
<p class="p1"><span class="Apple-converted-space">            </span>"Tu único límite es tu mente."</p>
<p class="p1"><span class="Apple-converted-space">        </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// App State</p>
<p class="p1"><span class="Apple-converted-space">        </span>const state = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentUser: null,</p>
<p class="p1"><span class="Apple-converted-space">            </span>years: ['2025', '2024'],</p>
<p class="p1"><span class="Apple-converted-space">            </span>months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],</p>
<p class="p1"><span class="Apple-converted-space">            </span>sectors: ['Agrícola', 'Construcción', 'Distribución', 'Gobierno', 'Heavy Rent'],</p>
<p class="p1"><span class="Apple-converted-space">            </span>selectedYear: '2025',</p>
<p class="p1"><span class="Apple-converted-space">            </span>selectedMonth: 'Junio',</p>
<p class="p1"><span class="Apple-converted-space">            </span>selectedCategory: 'dashboard',</p>
<p class="p1"><span class="Apple-converted-space">            </span>filterStatus: 'todos',</p>
<p class="p1"><span class="Apple-converted-space">            </span>selectedSector: 'todos',</p>
<p class="p1"><span class="Apple-converted-space">            </span>kpiDataByDate: {}, // Data will be loaded from Firestore</p>
<p class="p1"><span class="Apple-converted-space">            </span>charts: {}, // To hold chart instances</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// DOM Elements</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loginPage = document.getElementById('login-page');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dashboardPage = document.getElementById('dashboard-page');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loginForm = document.getElementById('login-form');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loginError = document.getElementById('login-error');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loginGreeting = document.getElementById('login-greeting');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const usernameInput = document.getElementById('username');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const passwordInput = document.getElementById('password');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const togglePasswordBtn = document.getElementById('toggle-password');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const rememberMeCheckbox = document.getElementById('remember-me');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const yearSelect = document.getElementById('year-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const monthSelect = document.getElementById('month-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const sectorSelect = document.getElementById('sector-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const statusFilterSelect = document.getElementById('status-filter-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const tabsList = document.getElementById('tabs-list');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const tabsContent = document.getElementById('tabs-content');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dashboardSubtitle = document.getElementById('dashboard-subtitle');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const manageBtn = document.getElementById('manage-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const exportBtn = document.getElementById('export-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const logoutBtn = document.getElementById('logout-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const managementModal = document.getElementById('management-modal');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalCloseBtn = document.getElementById('modal-close-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalCancelBtn = document.getElementById('modal-cancel-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalSaveBtn = document.getElementById('modal-save-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalYearSelect = document.getElementById('modal-year-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalMonthSelect = document.getElementById('modal-month-select');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const modalFormContent = document.getElementById('modal-form-content');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// HELPER &amp; UTILITY FUNCTIONS</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const formatCurrency = (value) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (typeof value !== 'number') return '$0';</p>
<p class="p1"><span class="Apple-converted-space">            </span>return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>const getInitialMonthData = () =&gt; JSON.parse(JSON.stringify({</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Procesos Internos': {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>'Satisfacción Entrega de Equipos': { value: 0, meta: 90, unit: '%', type: 'percentage' },<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>'Costo de Alisto BCP': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true },<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>'Costo de Alisto CAT': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true },<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>'Costo de Alisto JD': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true },<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Inventario': {</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación Caterpillar': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación John Deere': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación International': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación Mack': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación Volvo': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación Metso': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Rotación Otras Marcas': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Raw inventory data (these will be used to calculate percentages)</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Caterpillar Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Caterpillar Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario John Deere Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario John Deere Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario International Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario International Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Mack Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Mack Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Volvo Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Volvo Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Metso Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Inventario Metso Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Participación': { 'Participación Caterpillar PINS': { matra: 0, industria: 0, meta: 30, unit: '%', type: 'market_share' }, 'Participación John Deere': { matra: 0, industria: 0, meta: 25, unit: '%', type: 'market_share' }, 'Participación Mack Clase 8': { matra: 0, industria: 0, meta: 20, unit: '%', type: 'market_share' }, 'Participación International': { matra: 0, industria: 0, meta: 18, unit: '%', type: 'market_share' }, },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Ventas': { 'Agrícola': { ventas: 0, ventas_nuevas: 0, meta: 280000, type: 'venta_sector' }, 'Construcción': { ventas: 0, ventas_nuevas: 0, meta: 420000, type: 'venta_sector' }, 'Distribución': { ventas: 0, ventas_nuevas: 0, meta: 150000, type: 'venta_sector' }, 'Gobierno': { ventas: 0, ventas_nuevas: 0, meta: 75000, type: 'venta_sector' }, 'Heavy Rent': { ventas: 0, ventas_nuevas: 0, meta: 60000, type: 'venta_sector' }, },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Utilidad': { 'Agrícola': { uop: 0, meta: 28000, type: 'utilidad_sector' }, 'Construcción': { uop: 0, meta: 45000, type: 'utilidad_sector' }, 'Distribución': { uop: 0, meta: 18000, type: 'utilidad_sector' }, 'Gobierno': { uop: 0, meta: 8000, type: 'utilidad_sector' }, 'Heavy Rent': { uop: 0, meta: 7500, type: 'utilidad_sector' }, },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Cobertura': { 'Cobertura Construcción': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Agrícola': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Distribución': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Gobierno': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' } },</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Store raw data for derived KPIs (not displayed directly as tabs)</p>
<p class="p1"><span class="Apple-converted-space">            </span>'Datos de Origen': {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>'Equipos con CSA': { unidades_con_csa: 0, unidades_totales_cat_sem: 0, type: 'csa_raw' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'NLS Mensual': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'NLS Rolling 6': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' }</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const getKPIStatus = (kpi) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!kpi) return 'N/A';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Custom logic for new KPI types</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'new_client_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt; 30) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt;= 25) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'cobertura_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt; 90) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt;= 80) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'rotacion') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt; 2) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt;= 1.6 &amp;&amp; kpi.value &lt;= 2) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &lt; 1.6) return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'N/A';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'inventory_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Lower is better, so this is an inverted goal</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &lt; kpi.meta) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &lt; kpi.meta * 1.5) return 'Regular'; // Up to 50% over meta</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'csa_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt; 85) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt;= 60) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'nls_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt; 72) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.value &gt;= 65) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>let value, meta;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'venta_sector') { value = kpi.ventas; meta = kpi.meta; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>else if (kpi.type === 'utilidad_sector') { value = kpi.uop; meta = kpi.meta; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>else if (kpi.type === 'market_share') { value = kpi.industria &gt; 0 ? (kpi.matra / kpi.industria) * 100 : 0; meta = kpi.meta; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>else { value = kpi.value; meta = kpi.meta; }</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (meta === 0 || meta === undefined) return 'N/A';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const percentage = (value / meta) * 100;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.inverted) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (value &lt;= meta) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (value &lt;= meta * 1.1) return 'Regular'; // 10% over target</p>
<p class="p1"><span class="Apple-converted-space">                </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (percentage &gt;= 100) return 'Bueno';</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (percentage &gt;= 90) return 'Regular';</p>
<p class="p1"><span class="Apple-converted-space">            </span>return 'Malo';</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const getStatusStyles = (status) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const styles = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Bueno': { badge: 'bg-green-100 text-green-700', icon: 'check-circle', color: 'text-green-600' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Regular': { badge: 'bg-yellow-100 text-yellow-700', icon: 'alert-triangle', color: 'text-yellow-600' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'Malo': { badge: 'bg-red-100 text-red-700', icon: 'trending-down', color: 'text-red-600' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>'N/A': { badge: 'bg-gray-100 text-gray-600', icon: 'help-circle', color: 'text-gray-500' }</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p1"><span class="Apple-converted-space">            </span>return styles[status] || styles['N/A'];</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// DATA HANDLING &amp; PREPARATION</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Removed populateInitialData as data will be loaded from Firestore</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getPreviousMonth(year, month) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const monthIndex = state.months.indexOf(month);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (monthIndex === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>return { year: String(parseInt(year) - 1), month: state.months[11] };</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return { year, month: state.months[monthIndex - 1] };</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function getDataForDisplay(options = {}) { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { year: queryYear = state.selectedYear, month: queryMonth = state.selectedMonth, ignoreFilters = false } = options;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dateKey = `${queryYear}-${queryMonth}`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Start with a fresh initial data structure for the month</p>
<p class="p1"><span class="Apple-converted-space">            </span>let rawMonthData = JSON.parse(JSON.stringify(getInitialMonthData()));<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Try to get the document from Firestore</p>
<p class="p1"><span class="Apple-converted-space">                </span>const docRef = firebase_doc(db, 'kpis_por_mes', dateKey);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const docSnap = await firebase_getDoc(docRef);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (docSnap.exists()) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// If data exists in Firestore, merge it with the initial structure</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const fetchedData = docSnap.data();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Object.keys(rawMonthData).forEach(category =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (fetchedData[category]) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>Object.keys(rawMonthData[category]).forEach(kpiName =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>if (fetchedData[category][kpiName]) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>Object.assign(rawMonthData[category][kpiName], fetchedData[category][kpiName]);</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>console.log(`No se encontraron datos para ${dateKey} en Firestore. Inicializando y guardando plantilla.`);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// If no data, save the initial template to Firestore</p>
<p class="p1"><span class="Apple-converted-space">                    </span>await firebase_setDoc(docRef, rawMonthData);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error al obtener o guardar el documento de Firestore:", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert("No se pudieron cargar/inicializar los datos de la base de datos. Revisa tu conexión a internet y las reglas de Firebase.");</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Update local state with fetched (or initialized) data</p>
<p class="p1"><span class="Apple-converted-space">            </span>state.kpiDataByDate[queryYear] = state.kpiDataByDate[queryYear] || {};</p>
<p class="p1"><span class="Apple-converted-space">            </span>state.kpiDataByDate[queryYear][queryMonth] = rawMonthData;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// --- Dynamically create calculated KPIs based on rawMonthData ---</p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentData = JSON.parse(JSON.stringify(rawMonthData)); // Start with a copy of the raw data</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Calculated "Clientes Nuevos"</p>
<p class="p1"><span class="Apple-converted-space">            </span>const newClientsKpis = {};</p>
<p class="p1"><span class="Apple-converted-space">            </span>const sectorsForNewClients = ['Agrícola', 'Construcción', 'Distribución'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>let totalVentas = 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>let totalVentasNuevas = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(currentData.Ventas).forEach(([sector, data]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>totalVentas += data.ventas;</p>
<p class="p1"><span class="Apple-converted-space">                </span>totalVentasNuevas += data.ventas_nuevas;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (sectorsForNewClients.includes(sector)) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>newClientsKpis[`Clientes Nuevos ${sector}`] = {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>value: data.ventas &gt; 0 ? (data.ventas_nuevas / data.ventas) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>meta: 30, unit: '%', type: 'new_client_percentage'</p>
<p class="p1"><span class="Apple-converted-space">                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>newClientsKpis['Clientes Nuevos Ventas'] = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>value: totalVentas &gt; 0 ? (totalVentasNuevas / totalVentas) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>meta: 30, unit: '%', type: 'new_client_percentage'</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentData['Clientes Nuevos'] = newClientsKpis;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Calculated Inventory percentages</p>
<p class="p1"><span class="Apple-converted-space">            </span>const consolidatedInventory = {};</p>
<p class="p1"><span class="Apple-converted-space">            </span>const inventoryData = currentData['Inventario'] || {};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(inventoryData).forEach(([name, data]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (data.type === 'rotacion') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>consolidatedInventory[name] = data;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (data.type === 'inventory') { // These are the raw inventory inputs</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const cleanName = name.replace('Inventario ', '');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Create derived KPIs for inventory percentage &gt; 12 months</p>
<p class="p1"><span class="Apple-converted-space">                    </span>consolidatedInventory[`Inv. &gt; 12m - ${cleanName}`] = {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>value: data.total &gt; 0 ? (data.mayor_12_meses / data.total) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>meta: 10, unit: '%', type: 'inventory_percentage', inverted: true</p>
<p class="p1"><span class="Apple-converted-space">                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Create derived KPIs for inventory percentage &gt; 24 months</p>
<p class="p1"><span class="Apple-converted-space">                    </span>consolidatedInventory[`Inv. &gt; 24m - ${cleanName}`] = {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>value: data.total &gt; 0 ? (data.mayor_24_meses / data.total) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>meta: 5, unit: '%', type: 'inventory_percentage', inverted: true</p>
<p class="p1"><span class="Apple-converted-space">                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentData['Inventario'] = consolidatedInventory; // Replace raw inventory with calculated ones for display</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Calculated CSA and NLS percentages from "Datos de Origen"</p>
<p class="p1"><span class="Apple-converted-space">            </span>const csaData = currentData['Datos de Origen']['Equipos con CSA'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(csaData) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentData['Procesos Internos']['Equipos con CSA'] = {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value: csaData.unidades_totales_cat_sem &gt; 0 ? (csaData.unidades_con_csa / csaData.unidades_totales_cat_sem) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>meta: 85, unit: '%', type: 'csa_percentage'</p>
<p class="p1"><span class="Apple-converted-space">                </span>};</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const nlsMensualData = currentData['Datos de Origen']['NLS Mensual'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(nlsMensualData) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentData['Procesos Internos']['NLS Mensual'] = {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value: nlsMensualData.encuestas_totales &gt; 0 ? ((nlsMensualData.leales - nlsMensualData.riesgo) / nlsMensualData.encuestas_totales) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>meta: 72, unit: '%', type: 'nls_percentage'</p>
<p class="p1"><span class="Apple-converted-space">                </span>};</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const nlsRollingData = currentData['Datos de Origen']['NLS Rolling 6'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(nlsRollingData) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentData['Procesos Internos']['NLS Rolling 6'] = {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value: nlsRollingData.encuestas_totales &gt; 0 ? ((nlsRollingData.leales - nlsRollingData.riesgo) / nlsRollingData.encuestas_totales) * 100 : 0,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>meta: 72, unit: '%', type: 'nls_percentage'</p>
<p class="p1"><span class="Apple-converted-space">                </span>};</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Prepare all KPIs for filtering and grouping</p>
<p class="p1"><span class="Apple-converted-space">            </span>let allKpis = Object.entries(currentData).flatMap(([category, kpis]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Exclude the raw 'Datos de Origen' category from being displayed as a tab or KPI</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (category === 'Datos de Origen') return [];<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (category === 'Ventas' || category === 'Utilidad') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// For Sales and Utility, ensure we create KPIs like "Ventas Agrícola"</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return Object.entries(kpis).map(([sector, kpi]) =&gt; ({ name: `${category} ${sector}`, kpi, category }));</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>return Object.entries(kpis).map(([name, kpi]) =&gt; ({ name, kpi, category }));</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Apply filters if not ignored (e.g., for chat queries)</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!ignoreFilters) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Filter by sector</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (state.selectedSector !== 'todos') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const sectorKeywords = { 'Agrícola': ['John Deere', 'JD', 'Agrícola', 'Inventario John Deere', 'Cobertura Agrícola'], 'Construcción': ['Caterpillar', 'CAT', 'Metso', 'Mack', 'Construcción', 'BCP', 'CSA', 'Inventario Caterpillar', 'Inventario Metso', 'Cobertura Construcción'], 'Distribución': ['International', 'Distribución', 'Volvo', 'Inventario International', 'Inventario Mack', 'Inventario Volvo', 'Cobertura Distribución'], 'Gobierno': ['Gobierno', 'Cobertura Gobierno'], 'Heavy Rent': ['Heavy Rent'] };</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const keywords = sectorKeywords[state.selectedSector] || [];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>allKpis = allKpis.filter(({ name, category }) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Special handling for "Ventas" and "Utilidad" categories which include sector in their name directly</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if ((category === 'Ventas' || category === 'Utilidad' || category === 'Cobertura') &amp;&amp; name.includes(state.selectedSector)) return true;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// For other categories, check if the KPI name contains any of the sector keywords</p>
<p class="p1"><span class="Apple-converted-space">                        </span>return keywords.some(keyword =&gt; name.toLowerCase().includes(keyword.toLowerCase()));</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Filter by status</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (state.filterStatus !== 'todos') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>allKpis = allKpis.filter(item =&gt; getKPIStatus(item.kpi).toLowerCase() === state.filterStatus.toLowerCase());</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Group filtered KPIs by category for display</p>
<p class="p1"><span class="Apple-converted-space">            </span>const groupedData = allKpis.reduce((acc, { name, kpi, category }) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!acc[category]) acc[category] = {};</p>
<p class="p1"><span class="Apple-converted-space">                </span>acc[category][name] = kpi;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return acc;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, {});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>return {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentData: currentData, // This contains all raw and derived KPIs</p>
<p class="p1"><span class="Apple-converted-space">                </span>filteredData: groupedData, // This contains only filtered and grouped KPIs for display</p>
<p class="p1"><span class="Apple-converted-space">                </span>allKpis: allKpis // This contains all filtered KPIs as a flat array</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// AUTHENTICATION</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleLogin(event) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>event.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const username = usernameInput.value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const password = passwordInput.value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const user = users[username]; // Access local users object</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (user &amp;&amp; user.password === password) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.currentUser = user;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (rememberMeCheckbox.checked) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>localStorage.setItem('rememberedUser', username);</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>localStorage.removeItem('rememberedUser');</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>loginPage.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>dashboardPage.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>initDashboard(); // Call async initDashboard</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>loginError.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleLogout() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>state.currentUser = null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>dashboardPage.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>loginPage.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>setupLoginPage();</p>
<p class="p1"><span class="Apple-converted-space">            </span>loginForm.reset();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rememberedUser = localStorage.getItem('rememberedUser');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (rememberedUser) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>usernameInput.value = rememberedUser;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function setupLoginPage() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rememberedUser = localStorage.getItem('rememberedUser');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];</p>
<p class="p1"><span class="Apple-converted-space">            </span>let greetingHtml = '';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (rememberedUser &amp;&amp; users[rememberedUser]) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const user = users[rememberedUser];</p>
<p class="p1"><span class="Apple-converted-space">                </span>greetingHtml = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;h1 class="text-3xl font-bold text-white"&gt;Hola, ${user.firstName}&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="mt-2 text-sm text-gray-300"&gt;¡Qué bueno verte de nuevo!&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="mt-4 text-sm text-yellow-400 italic"&gt;"${randomQuote}"&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>usernameInput.value = rememberedUser;</p>
<p class="p1"><span class="Apple-converted-space">                </span>rememberMeCheckbox.checked = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>greetingHtml = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="mt-2 text-lg text-gray-200"&gt;Dashboard de Ventas - Balanced Scorecard&lt;br&gt;Ingrese para continuar.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;p class="mt-4 text-sm text-yellow-400 italic"&gt;"${randomQuote}"&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>loginGreeting.innerHTML = greetingHtml;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// RENDERING &amp; UI UPDATES</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function destroyAllCharts() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.values(state.charts).forEach(chart =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (chart) chart.destroy();</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>state.charts = {};</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function renderDashboard() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>destroyAllCharts();</p>
<p class="p1"><span class="Apple-converted-space">            </span>dashboardSubtitle.textContent = `Mostrando datos para ${state.selectedMonth} ${state.selectedYear}.`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Access control for manage button</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (state.currentUser &amp;&amp; state.currentUser.level === 'write') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>manageBtn.style.display = 'inline-flex';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>manageBtn.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>await renderTabs(); // Await renderTabs as it now depends on data</p>
<p class="p1"><span class="Apple-converted-space">            </span>await renderTabContent(); // Now awaits the content to be loaded and rendered</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function renderTabs() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { currentData } = await getDataForDisplay({ ignoreFilters: true }); // Get all categories, ignoring current filters</p>
<p class="p1"><span class="Apple-converted-space">            </span>const categoriesToDisplay = Object.keys(currentData).filter(cat =&gt; cat !== 'Datos de Origen'); // Exclude raw data category</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsList.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button data-tab="dashboard" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'dashboard' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}"&gt;Dashboard&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>${categoriesToDisplay.map(category =&gt; `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button data-tab="${category}" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === category ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}"&gt;${category}&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button data-tab="pronostico" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'pronostico' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}"&gt;Pronóstico&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button data-tab="analisis-ia" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'analisis-ia' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}"&gt;Análisis IA&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function renderTabContent() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { filteredData, allKpis, currentData } = await getDataForDisplay(); // Await data from Firestore</p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.innerHTML = ''; // Clear previous content</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (state.selectedCategory === 'dashboard') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderDashboardTab(allKpis);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (state.selectedCategory === 'pronostico') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderForecastTab();</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (state.selectedCategory === 'analisis-ia') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderAITab(currentData);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const categoryData = filteredData[state.selectedCategory];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (categoryData &amp;&amp; Object.keys(categoryData).length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(state.selectedCategory === 'Participación') {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>renderMarketShareTab(categoryData);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>renderKpiCategoryTab(categoryData, state.selectedCategory);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>tabsContent.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-center py-12 card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;i data-lucide="search-x" class="mx-auto h-12 w-12 text-gray-400"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="mt-2 text-sm font-medium text-gray-900"&gt;Sin resultados&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="mt-1 text-sm text-gray-500"&gt;No hay KPIs que coincidan con los filtros seleccionados en esta categoría.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function createKpiCardElement(name, kpi, category) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const template = document.getElementById('kpi-card-template');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const card = template.content.cloneNode(true);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const status = getKPIStatus(kpi);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const styles = getStatusStyles(status);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const { year: prevYear, month: prevMonth } = getPreviousMonth(state.selectedYear, state.selectedMonth);</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Get previous month's raw data for accurate trend calculation</p>
<p class="p1"><span class="Apple-converted-space">            </span>const prevRawData = state.kpiDataByDate[prevYear]?.[prevMonth] || getInitialMonthData();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Calculate previous month's derived KPIs for trend comparison</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { allKpis: prevAllKpis } = getDataForDisplay({ year: prevYear, month: prevMonth, ignoreFilters: true });</p>
<p class="p1"><span class="Apple-converted-space">            </span>const prevKpiFound = prevAllKpis.find(item =&gt; item.name === name);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const prevKpi = prevKpiFound ? prevKpiFound.kpi : null;</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>let displayValue, prevValue, valueForTrend;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Determine display value</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'venta_sector' || kpi.type === 'utilidad_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>displayValue = formatCurrency(kpi.ventas || kpi.uop);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.unit === '%') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>displayValue = `${kpi.value.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.unit === 'x') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>displayValue = `${kpi.value.toFixed(2)}${kpi.unit}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>displayValue = `${kpi.value?.toFixed(1) || 0}${kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Determine value for trend comparison (current and previous)</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'venta_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>valueForTrend = kpi.ventas;</p>
<p class="p1"><span class="Apple-converted-space">                </span>prevValue = prevKpi ? prevKpi.ventas : 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.type === 'utilidad_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>valueForTrend = kpi.uop;</p>
<p class="p1"><span class="Apple-converted-space">                </span>prevValue = prevKpi ? prevKpi.uop : 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.type === 'market_share') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>valueForTrend = kpi.industria &gt; 0 ? (kpi.matra / kpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>prevValue = prevKpi &amp;&amp; prevKpi.industria &gt; 0 ? (prevKpi.matra / prevKpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else { // Handles percentage, ratio, rotacion, inventory, csa, nls types</p>
<p class="p1"><span class="Apple-converted-space">                </span>valueForTrend = kpi.value;</p>
<p class="p1"><span class="Apple-converted-space">                </span>prevValue = prevKpi ? prevKpi.value : 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const difference = valueForTrend - prevValue;</p>
<p class="p1"><span class="Apple-converted-space">            </span>let trendHtml = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (difference &gt; 0.01) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>trendHtml = `&lt;i data-lucide="trending-up" class="w-3 h-3 mr-1 text-green-600"&gt;&lt;/i&gt;+${difference.toFixed(1)}${kpi.unit === '%' ? '%' : ''} vs mes anterior`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (difference &lt; -0.01) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>trendHtml = `&lt;i data-lucide="trending-down" class="w-3 h-3 mr-1 text-red-600"&gt;&lt;/i&gt;${difference.toFixed(1)}${kpi.unit === '%' ? '%' : ''} vs mes anterior`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>trendHtml = `&lt;i data-lucide="minus" class="w-3 h-3 mr-1 text-gray-500"&gt;&lt;/i&gt;Sin cambios`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>card.querySelector('.kpi-title').textContent = name;</p>
<p class="p1"><span class="Apple-converted-space">            </span>card.querySelector('.kpi-status-badge').textContent = status;</p>
<p class="p1"><span class="Apple-converted-space">            </span>card.querySelector('.kpi-status-badge').className = `kpi-status-badge mt-1 inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full ${styles.badge}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>card.querySelector('.kpi-value').textContent = displayValue;</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Adjust meta display for inventory percentages and others</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (kpi.type === 'inventory_percentage' || kpi.type === 'csa_percentage' || kpi.type === 'nls_percentage' || kpi.type === 'new_client_percentage' || kpi.type === 'cobertura_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta}${kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.type.includes('sector')) { // Venta y Utilidad</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.querySelector('.kpi-meta').textContent = `Meta: ${formatCurrency(kpi.meta)}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.unit) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta}${kpi.unit}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>card.querySelector('.kpi-trend').innerHTML = trendHtml;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (category === 'Utilidad') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const achievement = kpi.meta &gt; 0 ? (kpi.uop / kpi.meta) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const colorClass = achievement &gt;= 100 ? 'text-green-600' : achievement &gt;= 90 ? 'text-yellow-600' : 'text-red-600';</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.querySelector('.kpi-achievement').innerHTML = `&lt;div class="text-sm font-bold ${colorClass}"&gt;${achievement.toFixed(1)}% Logro&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (category === 'Ventas') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const achievement = kpi.meta &gt; 0 ? (kpi.ventas / kpi.meta) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const colorClass = achievement &gt;= 100 ? 'text-green-600' : achievement &gt;= 90 ? 'text-yellow-600' : 'text-red-600';</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.querySelector('.kpi-achievement').innerHTML = `&lt;div class="text-sm font-bold ${colorClass}"&gt;${achievement.toFixed(1)}% Logro&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (kpi.type === 'market_share' || kpi.type === 'percentage' || kpi.type === 'new_client_percentage' || kpi.type === 'cobertura_percentage' || kpi.type === 'csa_percentage' || kpi.type === 'nls_percentage') {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const achievement = kpi.meta &gt; 0 ? (kpi.value / kpi.meta) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>let colorClass;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.inverted) { // For inverted percentages (e.g., lower is better)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (kpi.value &lt; kpi.meta) colorClass = 'text-green-600'; // Better than meta</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else if (kpi.value &lt; kpi.meta * 1.5) colorClass = 'text-yellow-600'; // Within 50% over meta</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else colorClass = 'text-red-600'; // Much over meta</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (achievement &gt;= 100) colorClass = 'text-green-600';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else if (achievement &gt;= 90) colorClass = 'text-yellow-600';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else colorClass = 'text-red-600';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.querySelector('.kpi-achievement').innerHTML = `&lt;div class="text-sm font-bold ${colorClass}"&gt;${achievement.toFixed(1)}% Logro&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartCanvas = card.querySelector('.kpi-sparkline-chart');</p>
<p class="p1"><span class="Apple-converted-space">            </span>chartCanvas.id = `sparkline-chart-${name.replace(/\s+/g, '-')}`;<span class="Apple-converted-space"> </span></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>return card;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function initializeKpiCardChart(name, kpi, category) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartId = `sparkline-chart-${name.replace(/\s+/g, '-')}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartCanvas = document.getElementById(chartId);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!chartCanvas) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error(`Canvas with id ${chartId} not found.`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const sequence = getMonthSequence(state.selectedYear, state.selectedMonth, 12);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const historyData = sequence.map(({year, month}) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Get the *raw* data for each month in the sequence</p>
<p class="p1"><span class="Apple-converted-space">                </span>const monthRawData = state.kpiDataByDate[year]?.[month];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!monthRawData) return 0; // If no raw data, return 0 for that month</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Re-calculate derived KPIs for each month in the history sequence</p>
<p class="p1"><span class="Apple-converted-space">                </span>const { allKpis: historicalAllKpis } = getDataForDisplay({ year, month, ignoreFilters: true });</p>
<p class="p1"><span class="Apple-converted-space">                </span>const historicalKpi = historicalAllKpis.find(item =&gt; item.name === name);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!historicalKpi) return 0; // If KPI is not found for historical month (e.g., it's a new KPI type)</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (historicalKpi.kpi.type === 'venta_sector') return historicalKpi.kpi.ventas;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (historicalKpi.kpi.type === 'utilidad_sector') return historicalKpi.kpi.uop;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (historicalKpi.kpi.type === 'market_share') return historicalKpi.kpi.industria &gt; 0 ? (historicalKpi.kpi.matra / historicalKpi.kpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>// All other types should use the 'value' property directly</p>
<p class="p1"><span class="Apple-converted-space">                </span>return historicalKpi.kpi.value || 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>state.charts[`sparkline-${name}`] = new Chart(chartCanvas.getContext('2d'), {</p>
<p class="p1"><span class="Apple-converted-space">                </span>type: 'line',</p>
<p class="p1"><span class="Apple-converted-space">                </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>labels: sequence.map(s =&gt; s.month.substring(0,3)),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>datasets: [{</p>
<p class="p1"><span class="Apple-converted-space">                        </span>data: historyData,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderColor: '#6366f1',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderWidth: 2,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>fill: true,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>backgroundColor: 'rgba(99, 102, 241, 0.1)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>pointRadius: 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>tension: 0.4</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}]</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>responsive: true,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>maintainAspectRatio: false,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>interaction: {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>intersect: false,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>mode: 'index',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>plugins: {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>legend: { display: false },</p>
<p class="p1"><span class="Apple-converted-space">                        </span>tooltip: {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>enabled: true,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>backgroundColor: '#111827',</p>
<p class="p1"><span class="Apple-converted-space">                            </span>titleFont: { size: 12 },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>bodyFont: { size: 12 },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>padding: 8,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>displayColors: false,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>callbacks: {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>title: () =&gt; null, // Hide title</p>
<p class="p1"><span class="Apple-converted-space">                                </span>label: function(context) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>const monthLabel = context.label;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>let value = context.parsed.y;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>let formattedValue = '';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                                    </span>// Logic to format the value based on KPI type</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>if (kpi.type.includes('sector')) { // Venta y Utilidad</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>formattedValue = formatCurrency(value);</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>} else if (kpi.unit === '%') {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>formattedValue = `${value.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>} else if (kpi.unit === 'x') {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>formattedValue = `${value.toFixed(2)}${kpi.unit}`;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>formattedValue = `${value.toFixed(1)}${kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>}</p>
<p class="p2"><span class="Apple-converted-space">                                    </span></p>
<p class="p1"><span class="Apple-converted-space">                                    </span>return `${monthLabel}: ${formattedValue}`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scales: { x: { display: false }, y: { display: false } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderKpiCategoryTab(categoryData, categoryName) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(categoryData).forEach(([name, kpi]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>container.appendChild(createKpiCardElement(name, kpi, categoryName));</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.appendChild(container);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>Object.entries(categoryData).forEach(([name, kpi]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>initializeKpiCardChart(name, kpi, categoryName);</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderMarketShareTab(categoryData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>container.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartInfo = [];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(categoryData).forEach(([name, kpi]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const brand = name.replace('Participación ', '');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const chartData = state.months.map(month =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const monthRawData = state.kpiDataByDate[state.selectedYear]?.[month];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!monthRawData || !monthRawData['Participación']?.[name]) return { mes: month.substring(0,3), industria: 0, matra: 0, marketShare: 0 };</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>const monthKpi = monthRawData['Participación'][name];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>mes: month.substring(0,3),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>industria: monthKpi.industria,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>matra: monthKpi.matra,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>marketShare: monthKpi.industria &gt; 0 ? (monthKpi.matra / monthKpi.industria) * 100 : 0</p>
<p class="p1"><span class="Apple-converted-space">                    </span>};</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>chartInfo.push({ brand, chartData });</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const card = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.className = 'card';</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 md:p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-lg font-semibold"&gt;Participación de Mercado: ${brand}&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-gray-500"&gt;Unidades Matra vs. Total Industria (${state.selectedYear})&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="p-4 md:p-6 pt-0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div style="height: 250px;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;canvas id="market-share-chart-${brand.replace(/\s+/g, '')}"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>container.appendChild(card);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.appendChild(container);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>chartInfo.forEach(({ brand, chartData }) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const ctx = document.getElementById(`market-share-chart-${brand.replace(/\s+/g, '')}`).getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>state.charts[`market-share-${brand}`] = new Chart(ctx, {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>labels: chartData.map(d =&gt; d.mes),</p>
<p class="p1"><span class="Apple-converted-space">                            </span>datasets: [</p>
<p class="p1"><span class="Apple-converted-space">                                </span>{ label: 'Industria', data: chartData.map(d =&gt; d.industria), backgroundColor: '#d1d5db', yAxisID: 'y' },</p>
<p class="p1"><span class="Apple-converted-space">                                </span>{ label: 'Matra', data: chartData.map(d =&gt; d.matra), backgroundColor: '#4b5563', yAxisID: 'y' },</p>
<p class="p1"><span class="Apple-converted-space">                                </span>{ label: 'Market Share', data: chartData.map(d =&gt; d.marketShare), type: 'line', borderColor: '#f97316', tension: 0.1, yAxisID: 'y1', borderWidth: 2 }</p>
<p class="p1"><span class="Apple-converted-space">                            </span>]</p>
<p class="p1"><span class="Apple-converted-space">                        </span>},</p>
<p class="p1"><span class="Apple-converted-space">                        </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>responsive: true, maintainAspectRatio: false,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>scales: {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>y: { position: 'left', title: { display: true, text: 'Unidades' } },</p>
<p class="p1"><span class="Apple-converted-space">                                </span>y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Market Share (%)' } }</p>
<p class="p1"><span class="Apple-converted-space">                            </span>},</p>
<p class="p1"><span class="Apple-converted-space">                            </span>plugins: {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>tooltip: {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>callbacks: {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>title: (tooltipItems) =&gt; `Mes: ${tooltipItems[0].label}`,</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>label: (context) =&gt; '',</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>afterBody: (tooltipItems) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>const index = tooltipItems[0].dataIndex;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>const dataPoint = chartData[index];</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>return [</p>
<p class="p1"><span class="Apple-converted-space">                                                </span>`Industria: ${dataPoint.industria.toLocaleString()}`,</p>
<p class="p1"><span class="Apple-converted-space">                                                </span>`Matra: ${dataPoint.matra.toLocaleString()}`,</p>
<p class="p1"><span class="Apple-converted-space">                                                </span>`% MS: ${dataPoint.marketShare.toFixed(2)}%`</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>];</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderDashboardTab(allKpis) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const statusGroups = { Bueno: [], Regular: [], Malo: [], 'N/A': [] };</p>
<p class="p1"><span class="Apple-converted-space">            </span>allKpis.forEach(item =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const status = getKPIStatus(item.kpi);</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusGroups[status].push(item);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const sectorData = (dataType) =&gt; state.months.map(month =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const monthData = state.kpiDataByDate[state.selectedYear]?.[month];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!monthData) return { value: 0, meta: 0 };</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>let totalValue = 0, totalMeta = 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sectorsToSum = state.selectedSector === 'todos' ? state.sectors : [state.selectedSector];</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>sectorsToSum.forEach(sector =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const data = monthData[dataType][sector];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(data) { // Ensure data exists for the sector</p>
<p class="p1"><span class="Apple-converted-space">                        </span>totalValue += (dataType === 'Ventas' ? data.ventas : data.uop);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>totalMeta += data.meta;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>return { value: totalValue, meta: totalMeta };</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const salesData = sectorData('Ventas');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const utilityData = sectorData('Utilidad');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="space-y-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="grid grid-cols-1 lg:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="card p-6"&gt;&lt;div style="height: 250px;"&gt;&lt;canvas id="sales-trend-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="card p-6"&gt;&lt;div style="height: 250px;"&gt;&lt;canvas id="utility-trend-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="card p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-lg font-semibold"&gt;Desglose de KPIs por Estado&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-gray-500"&gt;Lista de KPIs clasificados según su rendimiento actual.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div id="kpi-status-lists" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// --- Sales Chart Logic ---</p>
<p class="p1"><span class="Apple-converted-space">                </span>const salesValues = salesData.map(d =&gt; d.value);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const maxSales = Math.max(...salesValues);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const minSales = Math.min(...salesValues.filter(v =&gt; v &gt; 0));</p>
<p class="p1"><span class="Apple-converted-space">                </span>const maxSalesIndex = salesValues.indexOf(maxSales);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const minSalesIndex = salesValues.indexOf(minSales);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const salesBarColors = salesValues.map((val, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (index === maxSalesIndex) return '#0065a2';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (index === minSalesIndex) return '#e77577';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return '#bfdbfe';</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>const salesCtx = document.getElementById('sales-trend-chart').getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.charts.salesTrend = new Chart(salesCtx, {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>labels: state.months.map(m =&gt; m.substring(0,3)),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>datasets: [</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Meta de Ventas', type: 'line', data: salesData.map(d =&gt; d.meta), borderColor: '#3b82f6', borderWidth: 2, tension: 0.1, pointRadius: 0 },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Ventas Reales', data: salesValues, backgroundColor: salesBarColors }</p>
<p class="p1"><span class="Apple-converted-space">                        </span>]</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>options: {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>responsive: true, maintainAspectRatio: false,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>plugins: {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>title: { display: true, text: `Tendencia de Ventas ${state.selectedSector !== 'todos' ? `(${state.selectedSector})` : '(General)'}` },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>tooltip: { callbacks: { footer: (tooltipItems) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const index = tooltipItems[0].dataIndex;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const real = salesData[index].value;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const meta = salesData[index].meta;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const achievement = meta &gt; 0 ? (real / meta) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>return `% de Logro: ${achievement.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}}}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>},<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>scales: { y: { ticks: { callback: value =&gt; formatCurrency(value) } } }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// --- Utility Chart Logic ---</p>
<p class="p1"><span class="Apple-converted-space">                </span>const utilityValues = utilityData.map(d =&gt; d.value);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const maxUtility = Math.max(...utilityValues);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const minUtility = Math.min(...utilityValues.filter(v =&gt; v &gt; 0));</p>
<p class="p1"><span class="Apple-converted-space">                </span>const maxUtilityIndex = utilityValues.indexOf(maxUtility);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const minUtilityIndex = utilityValues.indexOf(minUtility);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const utilityBarColors = utilityValues.map((val, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (index === maxUtilityIndex) return '#0065a2';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (index === minUtilityIndex) return '#e77577';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return '#99f6e4'; // Changed this color to green for utility</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>const utilityCtx = document.getElementById('utility-trend-chart').getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.charts.utilityTrend = new Chart(utilityCtx, {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>labels: state.months.map(m =&gt; m.substring(0,3)),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>datasets: [</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Meta de Utilidad', type: 'line', data: utilityData.map(d =&gt; d.meta), borderColor: '#14b8a6', borderWidth: 2, tension: 0.1, pointRadius: 0 },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Utilidad Real', data: utilityValues, backgroundColor: utilityBarColors }</p>
<p class="p1"><span class="Apple-converted-space">                        </span>]</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>options: {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>responsive: true, maintainAspectRatio: false,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>plugins: {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                            </span>title: { display: true, text: `Tendencia de Utilidad Op. ${state.selectedSector !== 'todos' ? `(${state.selectedSector})` : '(General)'}` },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>tooltip: { callbacks: { footer: (tooltipItems) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const index = tooltipItems[0].dataIndex;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const utility = utilityData[index].value;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const sales = salesData[index].value;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const margin = sales &gt; 0 ? (utility / sales) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>return `% Utilidad Op: ${margin.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}}}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>},<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>scales: { y: { ticks: { callback: value =&gt; formatCurrency(value) } } }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Render status lists</p>
<p class="p1"><span class="Apple-converted-space">                </span>const listsContainer = document.getElementById('kpi-status-lists');</p>
<p class="p1"><span class="Apple-converted-space">                </span>listsContainer.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">                </span>Object.entries(statusGroups).forEach(([status, kpis]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (kpis.length === 0) return; // Don't render empty groups</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const styles = getStatusStyles(status);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const listHtml = kpis.map(item =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const { year: prevYear, month: prevMonth } = getPreviousMonth(state.selectedYear, state.selectedMonth);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const prevRawData = state.kpiDataByDate[prevYear]?.[prevMonth] || getInitialMonthData();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>const { allKpis: prevAllKpis } = getDataForDisplay({ year: prevYear, month: prevMonth, ignoreFilters: true });</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const prevKpiFound = prevAllKpis.find(elem =&gt; elem.name === item.name);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const prevKpi = prevKpiFound ? prevKpiFound.kpi : null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>let displayValue, prevValue, valueForTrend;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (item.kpi.type === 'venta_sector' || item.kpi.type === 'utilidad_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>displayValue = formatCurrency(item.kpi.ventas || item.kpi.uop);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else if (item.kpi.unit === '%') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>displayValue = `${item.kpi.value.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else if (item.kpi.unit === 'x') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>displayValue = `${item.kpi.value.toFixed(2)}${item.kpi.unit}`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>displayValue = `${item.kpi.value?.toFixed(1) || 0}${item.kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (item.kpi.type === 'venta_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>valueForTrend = item.kpi.ventas;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>prevValue = prevKpi ? prevKpi.ventas : 0;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else if (item.kpi.type === 'utilidad_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>valueForTrend = item.kpi.uop;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>prevValue = prevKpi ? prevKpi.uop : 0;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else if (item.kpi.type === 'market_share') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>valueForTrend = item.kpi.industria &gt; 0 ? (item.kpi.matra / item.kpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>prevValue = prevKpi &amp;&amp; prevKpi.industria &gt; 0 ? (prevKpi.matra / prevKpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else { // Handles percentage, ratio, rotacion, inventory, csa, nls types</p>
<p class="p1"><span class="Apple-converted-space">                            </span>valueForTrend = item.kpi.value;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>prevValue = prevKpi ? prevKpi.value : 0;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>const difference = valueForTrend - prevValue;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>let trendIcon = '';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (difference &gt; 0.01) trendIcon = `&lt;i data-lucide="trending-up" class="w-4 h-4 text-green-600"&gt;&lt;/i&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>else if (difference &lt; -0.01) trendIcon = `&lt;i data-lucide="trending-down" class="w-4 h-4 text-red-600"&gt;&lt;/i&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>else trendIcon = `&lt;i data-lucide="minus" class="w-4 h-4 text-gray-500"&gt;&lt;/i&gt;`;</p>
<p class="p2"><span class="Apple-converted-space">                        </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>return `</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p class="text-sm font-medium text-gray-800"&gt;${item.name}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p class="text-sm text-gray-500"&gt;Valor: ${displayValue}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>${trendIcon}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}).join('');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>listsContainer.innerHTML += `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="bg-gray-50 p-4 rounded-xl"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;button class="collapsible-trigger w-full flex items-center justify-between mb-4 text-left"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;i data-lucide="${styles.icon}" class="w-5 h-5 ${styles.color}"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;h4 class="ml-2 font-semibold text-lg"&gt;${status}&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;span class="mr-2 text-sm font-bold text-gray-500"&gt;${kpis.length}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;i data-lucide="chevron-down" class="w-5 h-5 text-gray-600 transition-transform"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="collapsible-content open"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="space-y-3 pt-2 border-t"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>${kpis.length &gt; 0 ? listHtml : `&lt;p class="text-sm text-gray-500 text-center py-4"&gt;No hay KPIs en este estado.&lt;/p&gt;`}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderForecastTab() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex flex-col sm:flex-row justify-between items-start sm:items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;h3 class="text-lg font-semibold"&gt;Pronóstico de Ventas y Utilidad&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-sm text-gray-500"&gt;Proyección basada en tendencia histórica para el sector: &lt;span class="font-semibold"&gt;${state.selectedSector === 'todos' ? 'General' : state.selectedSector}&lt;/span&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="flex items-center space-x-2 mt-4 sm:mt-0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;label for="forecast-months" class="text-sm"&gt;Meses a Pronosticar:&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input id="forecast-months-slider" type="range" min="1" max="12" value="6" class="w-32"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;span id="forecast-months-label" class="font-bold"&gt;6&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="text-md font-semibold mb-2"&gt;Ventas&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div style="height: 250px;"&gt;&lt;canvas id="forecast-sales-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h4 class="text-md font-semibold mb-2"&gt;Utilidad Operativa&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div style="height: 250px;"&gt;&lt;canvas id="forecast-utility-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const slider = document.getElementById('forecast-months-slider');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const label = document.getElementById('forecast-months-label');</p>
<p class="p1"><span class="Apple-converted-space">                </span>slider.addEventListener('input', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>label.textContent = e.target.value;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>updateForecastCharts(parseInt(e.target.value));</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateForecastCharts(6);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateForecastCharts(forecastMonths) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const linearRegression = (data) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const n = data.length;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (n &lt; 2) return (x) =&gt; data[0]?.y || 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sumX = data.reduce((acc, d) =&gt; acc + d.x, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sumY = data.reduce((acc, d) =&gt; acc + d.y, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sumXY = data.reduce((acc, d) =&gt; acc + d.x * d.y, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sumXX = data.reduce((acc, d) =&gt; acc + d.x * d.x, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const intercept = (sumY - slope * sumX) / n;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(isNaN(slope) || isNaN(intercept)) return (x) =&gt; data[data.length-1]?.y || 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return (x) =&gt; Math.max(0, slope * x + intercept);</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const getHistoricalData = (dataType) =&gt; state.months.map(month =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const monthData = state.kpiDataByDate[state.selectedYear]?.[month];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!monthData) return 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>let totalValue = 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sectorsToSum = state.selectedSector === 'todos' ? state.sectors : [state.selectedSector];</p>
<p class="p1"><span class="Apple-converted-space">                </span>sectorsToSum.forEach(sector =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const data = monthData[dataType][sector];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(data) totalValue += (dataType === 'Ventas' ? data.ventas : data.uop);</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>return totalValue;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const historicalSales = getHistoricalData('Ventas');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const historicalUtility = getHistoricalData('Utilidad');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const salesPoints = historicalSales.map((y, x) =&gt; ({x, y}));</p>
<p class="p1"><span class="Apple-converted-space">            </span>const utilityPoints = historicalUtility.map((y, x) =&gt; ({x, y}));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const salesRegression = linearRegression(salesPoints);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const utilityRegression = linearRegression(utilityPoints);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const forecastSales = Array.from({length: forecastMonths}, (_, i) =&gt; salesRegression(historicalSales.length + i));</p>
<p class="p1"><span class="Apple-converted-space">            </span>const forecastUtility = Array.from({length: forecastMonths}, (_, i) =&gt; utilityRegression(historicalUtility.length + i));</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const allLabels = [...state.months.map(m =&gt; m.substring(0,3))];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const lastMonthIndex = state.months.length -1;</p>
<p class="p1"><span class="Apple-converted-space">            </span>for(let i=0; i&lt;forecastMonths; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>allLabels.push(state.months[(lastMonthIndex + i + 1) % 12].substring(0,3));</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const salesData = [...historicalSales, ...forecastSales];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const utilityData = [...historicalUtility, ...forecastUtility];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const renderChart = (id, chartName, data, historicalData, color) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const ctx = document.getElementById(id).getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (state.charts[id]) state.charts[id].destroy();</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.charts[id] = new Chart(ctx, {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>type: 'line',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>labels: allLabels.slice(0, data.length),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>datasets: [</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Histórico', data: historicalData, borderColor: color, tension: 0.1, borderWidth: 2 },</p>
<p class="p1"><span class="Apple-converted-space">                            </span>{ label: 'Pronóstico', data: Array(historicalData.length-1).fill(null).concat(data.slice(historicalData.length-1)), borderColor: color, borderDash: [5, 5], tension: 0.1, borderWidth: 2 }</p>
<p class="p1"><span class="Apple-converted-space">                        </span>]</p>
<p class="p1"><span class="Apple-converted-space">                    </span>},</p>
<p class="p1"><span class="Apple-converted-space">                    </span>options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value =&gt; formatCurrency(value) } } } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>renderChart('forecast-sales-chart', 'Ventas', salesData, historicalSales, '#3b82f6');</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderChart('forecast-utility-chart', 'Utilidad Operativa', utilityData, historicalUtility, '#14b8a6');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderAITab(currentData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="grid grid-cols-1 lg:grid-cols-2 gap-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="card lg:col-span-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-semibold flex items-center gap-2"&gt;&lt;i data-lucide="sparkles" class="text-yellow-500"&gt;&lt;/i&gt;Análisis General del Mes&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-gray-500"&gt;Resumen y recomendaciones generadas por IA para ${state.selectedMonth} ${state.selectedYear}.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;button id="generate-ai-analysis-btn" class="w-full btn btn-primary gap-2"&gt;&lt;i data-lucide="sparkles" class="w-4 h-4"&gt;&lt;/i&gt;Generar Análisis&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div id="ai-analysis-content" class="mt-4 prose prose-sm max-w-none text-gray-700"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="card lg:col-span-1 flex flex-col"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-semibold flex items-center gap-2"&gt;&lt;i data-lucide="brain-circuit" class="text-purple-500"&gt;&lt;/i&gt;Chat de Datos&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-gray-500"&gt;Pregúntale a la IA sobre los datos del mes actual.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-6 flex-1 flex flex-col"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div id="chat-history" class="flex-1 overflow-y-auto bg-gray-100 p-4 rounded-md space-y-4 h-64 border border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div class="flex flex-col items-center justify-center h-full text-center text-gray-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;i data-lucide="brain-circuit" class="w-10 h-10 mb-2"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p&gt;Haz una pregunta para empezar.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="p-6 border-t"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="flex w-full space-x-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;input id="chat-input" type="text" placeholder="Ej: ¿Cuál fue la utilidad de Construcción?" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;button id="chat-submit-btn" class="btn bg-purple-600 text-white hover:bg-purple-700 disabled:bg-purple-300"&gt;&lt;i data-lucide="send" class="w-4 h-4"&gt;&lt;/i&gt;&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>lucide.createIcons();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('generate-ai-analysis-btn').addEventListener('click', () =&gt; generateAIAnalysis(currentData));</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('chat-submit-btn').addEventListener('click', () =&gt; handleChatSubmit());</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('chat-input').addEventListener('keypress', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (e.key === 'Enter') handleChatSubmit();</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function generateAIAnalysis(currentData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const btn = document.getElementById('generate-ai-analysis-btn');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const contentDiv = document.getElementById('ai-analysis-content');</p>
<p class="p1"><span class="Apple-converted-space">            </span>btn.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>btn.innerHTML = `&lt;span class="animate-pulse"&gt;Generando...&lt;/span&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>contentDiv.innerHTML = `&lt;div class="mt-4 text-center text-gray-500 animate-pulse"&gt;Analizando datos...&lt;/div&gt;`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Get data for general analysis (ignoring current filters)</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { currentData: rawDataForAnalysis } = await getDataForDisplay({ ignoreFilters: true });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>let summary = `&lt;strong&gt;Análisis para ${state.selectedMonth} ${state.selectedYear}:&lt;/strong&gt;&lt;ul&gt;`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// General Sales and Utility analysis</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalSales = Object.values(rawDataForAnalysis.Ventas).reduce((sum, s) =&gt; sum + s.ventas, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalSalesMeta = Object.values(rawDataForAnalysis.Ventas).reduce((sum, s) =&gt; sum + s.meta, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalUtility = Object.values(rawDataForAnalysis.Utilidad).reduce((sum, u) =&gt; sum + u.uop, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalUtilityMeta = Object.values(rawDataForAnalysis.Utilidad).reduce((sum, u) =&gt; sum + u.meta, 0);</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>summary += `&lt;li&gt;&lt;strong&gt;Resumen General:&lt;/strong&gt; El rendimiento general de ${state.selectedMonth} ${state.selectedYear} ha sido `;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (totalSales &gt;= totalSalesMeta * 0.95 &amp;&amp; totalUtility &gt;= totalUtilityMeta * 0.95) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `**sólido** con ventas y utilidad cerca o por encima de las metas.`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (totalSales &gt;= totalSalesMeta * 0.8 &amp;&amp; totalUtility &gt;= totalUtilityMeta * 0.8) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `**aceptable**, pero hay áreas con oportunidad de mejora.`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `**desafiante**, requiriendo atención en varios frentes.`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>summary += ` (Ventas: ${formatCurrency(totalSales)} / Meta: ${formatCurrency(totalSalesMeta)} | Utilidad: ${formatCurrency(totalUtility)} / Meta: ${formatCurrency(totalUtilityMeta)}).&lt;/li&gt;`;</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Analyze key areas based on their status (Buen, Regular, Malo)</p>
<p class="p1"><span class="Apple-converted-space">                </span>const { allKpis: allCalculatedKpis } = getDataForDisplay({ ignoreFilters: true }); // Get all KPIs with their calculated status</p>
<p class="p1"><span class="Apple-converted-space">                </span>const goodKpis = allCalculatedKpis.filter(k =&gt; getKPIStatus(k.kpi) === 'Bueno');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const regularKpis = allCalculatedKpis.filter(k =&gt; getKPIStatus(k.kpi) === 'Regular');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const badKpis = allCalculatedKpis.filter(k =&gt; getKPIStatus(k.kpi) === 'Malo');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (goodKpis.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `&lt;li&gt;&lt;strong&gt;Puntos Fuertes:&lt;/strong&gt; Se destaca el buen desempeño en: ${goodKpis.map(k =&gt; `**${k.name}** (${k.kpi.value?.toFixed(1) || k.kpi.ventas || k.kpi.uop || ''}${k.kpi.unit || ''})`).join(', ')}. Estos indicadores superaron las expectativas.&lt;/li&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (badKpis.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `&lt;li&gt;&lt;strong&gt;Áreas de Oportunidad (Requieren Atención):&lt;/strong&gt; Se identifican desafíos en: ${badKpis.map(k =&gt; `**${k.name}** (${k.kpi.value?.toFixed(1) || k.kpi.ventas || k.kpi.uop || ''}${k.kpi.unit || ''})`).join(', ')}. Es crucial analizar las causas y desarrollar planes de acción.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Specific recommendation for top 'Malo' KPI</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const firstBadKpi = badKpis[0];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (firstBadKpi) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>summary += ` Enfocar la estrategia en mejorar **${firstBadKpi.name}**.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `&lt;/li&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (regularKpis.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summary += `&lt;li&gt;&lt;strong&gt;Áreas a Monitorear:&lt;/strong&gt; ${regularKpis.map(k =&gt; `**${k.name}** (${k.kpi.value?.toFixed(1) || k.kpi.ventas || k.kpi.uop || ''}${k.kpi.unit || ''})`).join(', ')}. Estos KPIs están cerca de la meta pero necesitan seguimiento constante para asegurar su mejora.&lt;/li&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>summary += `&lt;li&gt;&lt;strong&gt;Recomendación General:&lt;/strong&gt; Mantener el impulso en las áreas de fortaleza y asignar recursos prioritarios a las áreas de oportunidad. Considerar revisar los procesos y estrategias de venta para los sectores o KPIs con bajo rendimiento.&lt;/li&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>summary += `&lt;/ul&gt;`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>contentDiv.innerHTML = summary;</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.innerHTML = `✨ Generar Análisis`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 2000);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function handleChatSubmit() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const input = document.getElementById('chat-input');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const chatHistoryDiv = document.getElementById('chat-history');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const userMessage = input.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!userMessage) return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add user message to chat</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatHistoryDiv.innerHTML += `&lt;div class="flex justify-end"&gt;&lt;div class="p-3 rounded-lg max-w-sm bg-blue-500 text-white"&gt;${userMessage}&lt;/div&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>input.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add thinking indicator</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatHistoryDiv.innerHTML += `&lt;div id="thinking-bubble" class="flex justify-start"&gt;&lt;div class="p-3 rounded-lg bg-gray-200 text-gray-500 animate-pulse"&gt;Pensando...&lt;/div&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(async () =&gt; { // Made inner function async to await getDataForDisplay</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('thinking-bubble').remove();</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const lowerCaseInput = userMessage.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">                </span>let queryYear = state.selectedYear;</p>
<p class="p1"><span class="Apple-converted-space">                </span>let queryMonth = state.selectedMonth;</p>
<p class="p1"><span class="Apple-converted-space">                </span>let aiResponse = "Lo siento, no pude encontrar información específica sobre eso. Intenta reformular tu pregunta, o pregunta por un KPI, sector o período específico (ej. 'ventas de Construcción en Febrero 2024').";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Check for year</p>
<p class="p1"><span class="Apple-converted-space">                </span>const yearMatch = lowerCaseInput.match(/\b(20\d{2})\b/);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (yearMatch) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>queryYear = yearMatch[0];</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Check for month</p>
<p class="p1"><span class="Apple-converted-space">                </span>const monthMatch = state.months.find(m =&gt; lowerCaseInput.includes(m.toLowerCase()));</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (monthMatch) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>queryMonth = monthMatch;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Get the data for the specified (or default) period</p>
<p class="p1"><span class="Apple-converted-space">                </span>const { allKpis: dataForQuery, currentData: rawDataForQuery } = await getDataForDisplay({</p>
<p class="p1"><span class="Apple-converted-space">                    </span>year: queryYear,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>month: queryMonth,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>ignoreFilters: true // Important!</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// GENERAL QUESTIONS</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (lowerCaseInput.includes('hola') || lowerCaseInput.includes('saludos')) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>aiResponse = `¡Hola! ¿Cómo puedo ayudarte con los datos de KPIs para ${queryMonth} ${queryYear}?`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else if (lowerCaseInput.includes('ventas totales')) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const totalSales = Object.values(rawDataForQuery.Ventas).reduce((sum, s) =&gt; sum + s.ventas, 0);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>aiResponse = `Las ventas totales para ${queryMonth} ${queryYear} fueron de ${formatCurrency(totalSales)}.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else if (lowerCaseInput.includes('utilidad total')) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const totalUtility = Object.values(rawDataForQuery.Utilidad).reduce((sum, u) =&gt; sum + u.uop, 0);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>aiResponse = `La utilidad operativa total para ${queryMonth} ${queryYear} fue de ${formatCurrency(totalUtility)}.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else if (lowerCaseInput.includes('resumen del mes') || lowerCaseInput.includes('análisis general')) {</p>
<p class="p1"><span class="Apple-converted-space">                         </span>const sales = Object.values(rawDataForQuery.Ventas).reduce((sum, s) =&gt; sum + s.ventas, 0);</p>
<p class="p1"><span class="Apple-converted-space">                         </span>const utility = Object.values(rawDataForQuery.Utilidad).reduce((sum, u) =&gt; sum + u.uop, 0);</p>
<p class="p1"><span class="Apple-converted-space">                         </span>const csaCoverage = rawDataForQuery['Procesos Internos']['Equipos con CSA']?.value || 0;</p>
<p class="p1"><span class="Apple-converted-space">                         </span>const nlsScore = rawDataForQuery['Procesos Internos']['NLS Mensual']?.value || 0;</p>
<p class="p1"><span class="Apple-converted-space">                         </span>aiResponse = `En ${queryMonth} ${queryYear}, las ventas totales fueron ${formatCurrency(sales)} y la utilidad operativa fue ${formatCurrency(utility)}. El porcentaje de equipos con CSA fue del ${csaCoverage.toFixed(1)}% y el NLS mensual de ${nlsScore.toFixed(1)}%.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>// Check for specific KPI mentions including sector or category</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const foundKpi = dataForQuery.find(k =&gt; lowerCaseInput.includes(k.name.toLowerCase()));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (foundKpi) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const { name, kpi } = foundKpi;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>let displayValue = '';</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (kpi.type === 'venta_sector' || kpi.type === 'utilidad_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>displayValue = formatCurrency(kpi.ventas || kpi.uop);</p>
<p class="p1"><span class="Apple-converted-space">                            </span>} else if (kpi.unit === '%') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>displayValue = `${kpi.value.toFixed(1)}%`;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>} else if (kpi.unit === 'x') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>displayValue = `${kpi.value.toFixed(2)}${kpi.unit}`;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>} else if (kpi.type === 'inventory' || kpi.type === 'csa_raw' || kpi.type === 'nls_raw') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>// This means a raw data KPI was asked, format it specifically</p>
<p class="p1"><span class="Apple-converted-space">                                </span>if (name.includes('Inventario') &amp;&amp; kpi.total !== undefined) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>displayValue = `Total: ${formatCurrency(kpi.total)}, &gt;12m: ${formatCurrency(kpi.mayor_12_meses)}, &gt;24m: ${formatCurrency(kpi.mayor_24_meses)}`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>} else if (name.includes('CSA') &amp;&amp; kpi.unidades_totales_cat_sem !== undefined) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>displayValue = `${kpi.unidades_con_csa.toFixed(0)} de ${kpi.unidades_totales_cat_sem.toFixed(0)} unidades (${(kpi.unidades_con_csa / kpi.unidades_totales_cat_sem * 100).toFixed(1)}%)`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>} else if (name.includes('NLS') &amp;&amp; kpi.encuestas_totales !== undefined) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>displayValue = `${kpi.leales.toFixed(0)} leales, ${kpi.riesgo.toFixed(0)} en riesgo de ${kpi.encuestas_totales.toFixed(0)} encuestas.`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                                     </span>displayValue = `${kpi.value?.toFixed(1) || 0}${kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                                 </span>displayValue = `${kpi.value?.toFixed(1) || 0}${kpi.unit || ''}`;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>aiResponse = `Para "${name}" en ${queryMonth} ${queryYear}, el valor fue: ${displayValue}. Estado: ${getKPIStatus(kpi)}.`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>} catch (e) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>console.error("Error in chat logic:", e);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>aiResponse = "Tuve un problema al procesar tu pregunta con los datos actuales. Asegúrate de que los datos estén cargados.";</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>chatHistoryDiv.innerHTML += `&lt;div class="flex justify-start"&gt;&lt;div class="p-3 rounded-lg max-w-sm bg-gray-200 text-gray-800"&gt;${aiResponse}&lt;/div&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 1500);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// MODAL &amp; DATA MANAGEMENT</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function openManagementModal() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalYearSelect.value = state.selectedYear;</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalMonthSelect.value = state.selectedMonth;</p>
<p class="p1"><span class="Apple-converted-space">            </span>await populateModalForm(state.selectedYear, state.selectedMonth); // Await populateForm</p>
<p class="p1"><span class="Apple-converted-space">            </span>managementModal.showModal();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function populateModalForm(year, month) { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Fetch the raw data for the selected month/year directly from Firestore (or use the already loaded one)</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dateKey = `${year}-${month}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>let dataToEdit = JSON.parse(JSON.stringify(getInitialMonthData())); // Start with a clean template</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const docRef = firebase_doc(db, 'kpis_por_mes', dateKey);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const docSnap = await firebase_getDoc(docRef);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (docSnap.exists()) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Merge fetched data into the template, but only for the 'raw' parts</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const fetchedData = docSnap.data();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Object.keys(dataToEdit).forEach(category =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (fetchedData[category]) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>// Only copy raw data directly. Calculated categories will be re-calculated.</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (category === 'Ventas' || category === 'Utilidad' || category === 'Participación' || category === 'Procesos Internos' || category === 'Datos de Origen' || category === 'Cobertura') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>Object.keys(dataToEdit[category]).forEach(kpiName =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>if (fetchedData[category][kpiName]) {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>Object.assign(dataToEdit[category][kpiName], fetchedData[category][kpiName]);</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>// Special handling for 'Inventario' category, as it contains both raw and calculated data types</p>
<p class="p1"><span class="Apple-converted-space">                            </span>else if (category === 'Inventario') {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>// We only want to populate raw inventory inputs here for editing</p>
<p class="p1"><span class="Apple-converted-space">                                </span>Object.keys(dataToEdit[category]).forEach(kpiName =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>if (dataToEdit[category][kpiName].type === 'inventory' &amp;&amp; fetchedData[category][kpiName]) {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>Object.assign(dataToEdit[category][kpiName], fetchedData[category][kpiName]);</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>} else if (dataToEdit[category][kpiName].type === 'rotacion' &amp;&amp; fetchedData[category][kpiName]) {</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>Object.assign(dataToEdit[category][kpiName], fetchedData[category][kpiName]);</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error loading data for modal:", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert("Error al cargar datos para el modal de administración.");</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>modalFormContent.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Categories to display in the modal for direct editing</p>
<p class="p1"><span class="Apple-converted-space">            </span>const categoriesToDisplayInModal = ['Procesos Internos', 'Participación', 'Ventas', 'Utilidad', 'Cobertura', 'Inventario', 'Datos de Origen'];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Object.entries(dataToEdit).forEach(([category, kpis]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(!categoriesToDisplayInModal.includes(category)) return; // Skip categories not meant for direct editing</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Filter KPIs within 'Inventario' to show only raw inputs and rotation</p>
<p class="p1"><span class="Apple-converted-space">                </span>let kpisForModal = Object.entries(kpis);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (category === 'Inventario') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>kpisForModal = kpisForModal.filter(([kpiName, kpiData]) =&gt; kpiData.type === 'inventory' || kpiData.type === 'rotacion');</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Filter KPIs within 'Procesos Internos' to show only direct inputs</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (category === 'Procesos Internos') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>kpisForModal = kpisForModal.filter(([kpiName, kpiData]) =&gt; !['Equipos con CSA', 'NLS Mensual', 'NLS Rolling 6'].includes(kpiName));</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const categoryHtml = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;h4 class="font-semibold text-lg mb-2 border-b pb-2"&gt;${category}&lt;/h4&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-1 md:grid-cols-2 gap-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${kpisForModal.map(([kpiName, kpiData]) =&gt; `</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;p class="font-medium text-sm mb-3 text-white"&gt;${kpiName}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;div class="space-y-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>${Object.entries(kpiData).map(([field, value]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>if (field === 'type' || field === 'unit' || field === 'inverted') return ''; // Skip metadata</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>return `</p>
<p class="p1"><span class="Apple-converted-space">                                                </span>&lt;div class="flex items-center justify-between"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                                    </span>&lt;label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-${field}" class="capitalize text-sm text-gray-100"&gt;${field.replace(/_/g, ' ')}&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                                    </span>&lt;input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-${field}" type="number" step="any" value="${value}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                                        </span>}).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>`).join('')}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>modalFormContent.innerHTML += categoryHtml;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add Enter key navigation</p>
<p class="p1"><span class="Apple-converted-space">            </span>const inputs = modalFormContent.querySelectorAll('input[data-form-input="true"]');</p>
<p class="p1"><span class="Apple-converted-space">            </span>inputs.forEach((input, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>input.addEventListener('keydown', (event) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (event.key === 'Enter') {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>event.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const nextInput = inputs[index + 1];</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (nextInput) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>nextInput.focus();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>modalSaveBtn.focus();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function saveModalChanges() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const year = modalYearSelect.value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const month = modalMonthSelect.value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dateKey = `${year}-${month}`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Start with the current raw data for the month to preserve untouched fields</p>
<p class="p1"><span class="Apple-converted-space">            </span>let rawDataToSave = JSON.parse(JSON.stringify(state.kpiDataByDate[year]?.[month] || getInitialMonthData()));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Define categories that contain directly editable fields in the modal</p>
<p class="p1"><span class="Apple-converted-space">            </span>const categoriesWithDirectInputs = ['Procesos Internos', 'Participación', 'Ventas', 'Utilidad', 'Cobertura', 'Inventario', 'Datos de Origen'];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Loop through the relevant categories and update rawDataToSave from form inputs</p>
<p class="p1"><span class="Apple-converted-space">            </span>categoriesWithDirectInputs.forEach(category =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (rawDataToSave[category]) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Object.entries(rawDataToSave[category]).forEach(([kpiName, kpiData]) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>Object.keys(kpiData).forEach(field =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (field === 'type' || field === 'unit' || field === 'inverted') return; // Skip metadata</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const input = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-${field}`);</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (input) {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>rawDataToSave[category][kpiName][field] = parseFloat(input.value) || 0;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Save the updated raw data to Firestore</p>
<p class="p1"><span class="Apple-converted-space">                </span>await firebase_setDoc(firebase_doc(db, 'kpis_por_mes', dateKey), rawDataToSave);</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert('¡Datos guardados exitosamente en la nube!');</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log("Document successfully written!");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Update local state AFTER successful save to cloud (this also re-calculates derived KPIs)</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.kpiDataByDate[year] = state.kpiDataByDate[year] || {};</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.kpiDataByDate[year][month] = rawDataToSave;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>state.selectedYear = year;</p>
<p class="p1"><span class="Apple-converted-space">                </span>state.selectedMonth = month;</p>
<p class="p1"><span class="Apple-converted-space">                </span>yearSelect.value = year;</p>
<p class="p1"><span class="Apple-converted-space">                </span>monthSelect.value = month;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>managementModal.close();</p>
<p class="p1"><span class="Apple-converted-space">                </span>await renderDashboard(); // Re-render the dashboard with the new data</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error writing document: ", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert('Hubo un error al guardar los datos. Revisa la consola (F12) para más detalles.');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getMonthSequence(endYearStr, endMonthStr, count) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const sequence = [];</p>
<p class="p1"><span class="Apple-converted-space">            </span>let currentYear = parseInt(endYearStr);</p>
<p class="p1"><span class="Apple-converted-space">            </span>let currentMonthIndex = state.months.indexOf(endMonthStr);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>for(let i=0; i&lt; count; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>sequence.unshift({ year: String(currentYear), month: state.months[currentMonthIndex]});</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentMonthIndex--;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (currentMonthIndex &lt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>currentMonthIndex = 11;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>currentYear--;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return sequence;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function handleExport() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { allKpis } = await getDataForDisplay({ignoreFilters: true}); // Await all data before export</p>
<p class="p1"><span class="Apple-converted-space">            </span>let csvContent = "data:text/csv;charset=utf-8,";</p>
<p class="p1"><span class="Apple-converted-space">            </span>csvContent += "Category,KPI,Status,Value,Meta\n";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>allKpis.forEach(({ category, name, kpi }) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const status = getKPIStatus(kpi);</p>
<p class="p1"><span class="Apple-converted-space">                </span>let value;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.type === 'venta_sector') value = kpi.ventas;</p>
<p class="p1"><span class="Apple-converted-space">                </span>else if (kpi.type === 'utilidad_sector') value = kpi.uop;</p>
<p class="p1"><span class="Apple-converted-space">                </span>else if (kpi.type === 'market_share') value = kpi.industria &gt; 0 ? (kpi.matra / kpi.industria) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>else value = kpi.value; // For percentage, ratio, rotacion, csa, nls, etc.</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Add specific raw values for export if applicable, otherwise use calculated value</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (kpi.type === 'inventory') { // Raw inventory has total, &gt;12m, &gt;24m</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value = `Total: ${kpi.total || 0}, &gt;12m: ${kpi.mayor_12_meses || 0}, &gt;24m: ${kpi.mayor_24_meses || 0}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (kpi.type === 'csa_raw') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value = `Con CSA: ${kpi.unidades_con_csa || 0}, Total: ${kpi.unidades_totales_cat_sem || 0}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (kpi.type === 'nls_raw') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value = `Leales: ${kpi.leales || 0}, Riesgo: ${kpi.riesgo || 0}, Total: ${kpi.encuestas_totales || 0}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (kpi.type === 'venta_sector') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>value = `Ventas: ${kpi.ventas || 0}, Ventas Nuevas: ${kpi.ventas_nuevas || 0}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const row = [category, `"${name}"`, status, value, kpi.meta || ''].join(','); // Ensure meta is exported, use empty string if undefined</p>
<p class="p1"><span class="Apple-converted-space">                </span>csvContent += row + "\n";</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const encodedUri = encodeURI(csvContent);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const link = document.createElement("a");</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.setAttribute("href", encodedUri);</p>
<p class="p1"><span class="Apple-converted-space">            </span>link.setAttribute("download", `kpi_export_${state.selectedMonth}_${state.selectedYear}.csv`);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.body.appendChild(link);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>link.click();</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.body.removeChild(link);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>// INITIALIZATION &amp; EVENT LISTENERS</p>
<p class="p1"><span class="Apple-converted-space">        </span>// ========================================================================</p>
<p class="p1"><span class="Apple-converted-space">        </span>async function initDashboard() { // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Populate selectors</p>
<p class="p1"><span class="Apple-converted-space">            </span>yearSelect.innerHTML = state.years.map(y =&gt; `&lt;option value="${y}"&gt;${y}&lt;/option&gt;`).join('');</p>
<p class="p1"><span class="Apple-converted-space">            </span>monthSelect.innerHTML = state.months.map(m =&gt; `&lt;option value="${m}"&gt;${m}&lt;/option&gt;`).join('');</p>
<p class="p1"><span class="Apple-converted-space">            </span>sectorSelect.innerHTML = `&lt;option value="todos"&gt;Todos los Sectores&lt;/option&gt;` + state.sectors.map(s =&gt; `&lt;option value="${s}"&gt;${s}&lt;/option&gt;`).join('');</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalYearSelect.innerHTML = yearSelect.innerHTML;</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalMonthSelect.innerHTML = monthSelect.innerHTML;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Set initial selector values</p>
<p class="p1"><span class="Apple-converted-space">            </span>yearSelect.value = state.selectedYear;</p>
<p class="p1"><span class="Apple-converted-space">            </span>monthSelect.value = state.selectedMonth;</p>
<p class="p1"><span class="Apple-converted-space">            </span>sectorSelect.value = state.selectedSector;</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusFilterSelect.value = state.filterStatus;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Initial render</p>
<p class="p1"><span class="Apple-converted-space">            </span>await renderDashboard(); // Await the initial dashboard render</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Event Listeners</p>
<p class="p1"><span class="Apple-converted-space">            </span>yearSelect.addEventListener('change', async (e) =&gt; { state.selectedYear = e.target.value; await renderDashboard(); });</p>
<p class="p1"><span class="Apple-converted-space">            </span>monthSelect.addEventListener('change', async (e) =&gt; { state.selectedMonth = e.target.value; await renderDashboard(); });</p>
<p class="p1"><span class="Apple-converted-space">            </span>sectorSelect.addEventListener('change', async (e) =&gt; { state.selectedSector = e.target.value; await renderDashboard(); });</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusFilterSelect.addEventListener('change', async (e) =&gt; { state.filterStatus = e.target.value; await renderDashboard(); });</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsList.addEventListener('click', async (e) =&gt; { // Made async</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (e.target.tagName === 'BUTTON') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>state.selectedCategory = e.target.dataset.tab;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>await renderDashboard();</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>tabsContent.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const trigger = e.target.closest('.collapsible-trigger');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (trigger) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const content = trigger.nextElementSibling;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const icon = trigger.querySelector('[data-lucide="chevron-down"], [data-lucide="chevron-up"]');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>content.classList.toggle('open');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (content.classList.contains('open')) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>icon.setAttribute('data-lucide', 'chevron-up');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>icon.setAttribute('data-lucide', 'chevron-down');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>manageBtn.addEventListener('click', openManagementModal);</p>
<p class="p1"><span class="Apple-converted-space">            </span>logoutBtn.addEventListener('click', handleLogout);</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalCloseBtn.addEventListener('click', () =&gt; managementModal.close());</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalCancelBtn.addEventListener('click', () =&gt; managementModal.close());</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalSaveBtn.addEventListener('click', saveModalChanges);</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalYearSelect.addEventListener('change', async (e) =&gt; await populateModalForm(e.target.value, modalMonthSelect.value)); // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>modalMonthSelect.addEventListener('change', async (e) =&gt; await populateModalForm(modalYearSelect.value, e.target.value)); // Made async</p>
<p class="p1"><span class="Apple-converted-space">            </span>exportBtn.addEventListener('click', handleExport);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Setup login page on initial load</p>
<p class="p1"><span class="Apple-converted-space">        </span>setupLoginPage();</p>
<p class="p1"><span class="Apple-converted-space">        </span>loginForm.addEventListener('submit', handleLogin);</p>
<p class="p1"><span class="Apple-converted-space">        </span>togglePasswordBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';</p>
<p class="p1"><span class="Apple-converted-space">            </span>passwordInput.setAttribute('type', type);</p>
<p class="p1"><span class="Apple-converted-space">            </span>togglePasswordBtn.innerHTML = type === 'password' ? '&lt;i data-lucide="eye" class="w-5 h-5"&gt;&lt;/i&gt;' : '&lt;i data-lucide="eye-off" class="w-5 h-5"&gt;&lt;/i&gt;';</p>
<p class="p1"><span class="Apple-converted-space">            </span>lucide.createIcons();</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
