<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de KPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.368.0/lucide.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Slate 200 - Fondo más oscuro para mayor contraste */
            color: #111827;
        }
        #login-page {
            background: url('https://images.unsplash.com/photo-1529369627985-2d9bcf543ea8?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
        }
        .login-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* Sombra más pronunciada */
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #facc15; /* Matra Yellow */
            color: #111827; /* Dark text */
            font-weight: 700;
        }
        .btn-primary:hover {
            background-color: #eab308;
        }
        .btn-secondary {
            background-color: white;
            color: #374151;
            border-color: #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #f3f4f6;
        }
        .tabs-list button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        dialog {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            padding: 0;
            width: 90%;
            max-width: 50rem;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
        }
        .collapsible-content.open {
            max-height: 1500px; /* Adjust as needed */
        }
        .prose { line-height: 1.7; }
        .prose strong { font-weight: 600; }
        .prose ul { list-style-position: inside; padding-left: 0.5rem; }
        .prose li::marker { content: '•'; color: #4b5563; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        /* Custom scrollbar for tabs */
        .tabs-list::-webkit-scrollbar {
            height: 4px;
        }
        .tabs-list::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        .tabs-list::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }
        .tabs-list::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt_2O9DN5qblHUaDnlKFkDKP270TezY6g",
            authDomain: "bsc-matra-app.firebaseapp.com",
            projectId: "bsc-matra-app",
            storageBucket: "bsc-matra-app.firebasestorage.app",
            messagingSenderId: "742996450855",
            appId: "1:742996450855:web:286a28f6acc3d61f63f802"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // Make db and Firestore functions globally accessible via window object
        window.db = getFirestore(app); 
        window.firebase_collection = collection; 
        window.firebase_doc = doc; 
        window.firebase_setDoc = setDoc; 
        window.firebase_getDoc = getDoc; 
    </script>

</head>
<body>

    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="login-overlay absolute inset-0"></div>
        <div class="relative w-full max-w-md p-8 space-y-6 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg">
            <div id="login-greeting" class="text-center">
                </div>
            <form id="login-form" class="space-y-6 mt-8">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-300">Usuario</label>
                    <input id="username" name="username" type="text" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-300">Contraseña</label>
                    <div class="relative">
                        <input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-yellow-500 bg-gray-700 border-gray-600 focus:ring-yellow-600 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-300">Recordarme</label>
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-400 hidden">Usuario o contraseña incorrectos.</p>
                <div>
                    <button type="submit" class="w-full btn btn-primary">
                        Iniciar Sesión
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="dashboard-page" class="hidden max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="pb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Dashboard de KPIs</h1>
                    <p id="dashboard-subtitle" class="mt-1 text-gray-500">Mostrando datos para Junio 2025.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <select id="year-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <select id="month-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <select id="sector-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <button id="manage-btn" class="btn btn-secondary"><i data-lucide="settings" class="w-4 h-4 mr-2"></i>Administrar</button>
                    <button id="export-btn" class="btn btn-secondary"><i data-lucide="download" class="w-4 h-4 mr-2"></i>Exportar</button>
                    <button id="logout-btn" class="btn btn-secondary"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i>Cerrar Sesión</button>
                </div>
            </div>
        </header>

        <main>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div id="tabs-list" class="tabs-list flex flex-nowrap space-x-1 border-b border-gray-200 overflow-x-auto w-full pb-1">
                    </div>
                <div class="flex items-center space-x-2 mt-4 sm:mt-0 w-full sm:w-auto sm:max-w-xs flex-shrink-0">
                    <i data-lucide="filter" class="w-4 h-4 text-gray-500"></i>
                    <select id="status-filter-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                        <option value="todos">Todos los Estados</option>
                        <option value="Bueno">Filtrar por "Bueno"</option>
                        <option value="Regular">Filtrar por "Regular"</option>
                        <option value="Malo">Filtrar por "Malo"</option>
                    </select>
                </div>
            </div>

            <div id="tabs-content" class="mt-6">
                </div>
        </main>
    </div>

    <dialog id="management-modal">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Administrar Datos de KPIs</h2>
                    <p class="text-sm text-gray-500 mt-1">Actualice los valores para el período seleccionado.</p>
                </div>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex gap-4 mb-4">
                <select id="modal-year-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                <select id="modal-month-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
            </div>
            <div id="modal-form-content" class="max-h-[60vh] overflow-y-auto pr-2 space-y-6">
                </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="modal-save-btn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </dialog>

    <template id="kpi-card-template">
        <div class="card flex flex-col">
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-start">
                    <h3 class="kpi-title text-base font-medium max-w-[70%]"></h3>
                    <div class="text-right">
                        <div class="kpi-achievement"></div>
                        <span class="kpi-status-badge mt-1 inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full"></span>
                    </div>
                </div>
            </div>
            <div class="p-4 md:p-6 pt-0">
                <div class="kpi-value text-3xl font-bold"></div>
                <div class="kpi-meta text-sm text-gray-500 mt-1"></div>
                <div class="kpi-trend mt-2 text-xs flex items-center"></div>
            </div>
            <div class="kpi-chart-container mt-auto p-4 md:p-6 pt-0">
                <div class="text-xs text-gray-500 mb-1">Tendencia (Últimos 12 meses)</div>
                <div style="height: 60px;">
                    <canvas class="kpi-sparkline-chart"></canvas>
                </div>
            </div>
        </div>
    </template>

    <script type="module"> // Set script type to "module"
    // Make Firebase objects available globally as the main script is not a module
    // and cannot directly import from the module script.
    // This allows the main script to use db, collection, doc, setDoc, getDoc.
    const db = window.db;
    const firebase_collection = window.firebase_collection;
    const firebase_doc = window.firebase_doc;
    const firebase_setDoc = window.firebase_setDoc;
    const firebase_getDoc = window.firebase_getDoc;

    document.addEventListener('DOMContentLoaded', async () => { // Made async
        // Initialize Lucide icons
        lucide.createIcons();

        // User Database (Simplified - consider Firebase Authentication for real apps)
        const users = {
            "EstelaVillalobos": { password: "estela@2025", level: "write", firstName: "Estela" },
            "HugoVargas": { password: "Hugo@2025", level: "read", firstName: "Hugo" },
            "CarlosCalderon": { password: "Carlos@2025", level: "read", firstName: "Carlos" },
            "GustavoSoto": { password: "Gustavo@2025", level: "read", firstName: "Gustavo" },
            "FranciscoRamirez": { password: "Francisco@2025", level: "read", firstName: "Francisco" }
        };

        const motivationalQuotes = [
            "El éxito es la suma de pequeños esfuerzos repetidos día tras día.",
            "Cree en ti mismo y todo lo que eres. Sé consciente de que hay algo dentro de ti que es más grande que cualquier obstáculo.",
            "El único lugar donde el éxito viene antes que el trabajo es en el diccionario.",
            "No esperes. El momento nunca será el adecuado.",
            "La mejor manera de predecir el futuro es crearlo.",
            "Tu único límite es tu mente."
        ];

        // App State
        const state = {
            currentUser: null,
            years: ['2025', '2024'],
            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            sectors: ['Agrícola', 'Construcción', 'Distribución', 'Gobierno', 'Heavy Rent'],
            selectedYear: '2025',
            selectedMonth: 'Junio',
            selectedCategory: 'dashboard',
            filterStatus: 'todos',
            selectedSector: 'todos',
            kpiDataByDate: {}, // Data will be loaded from Firestore
            charts: {}, // To hold chart instances
        };

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginGreeting = document.getElementById('login-greeting');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const sectorSelect = document.getElementById('sector-select');
        const statusFilterSelect = document.getElementById('status-filter-select');
        const tabsList = document.getElementById('tabs-list');
        const tabsContent = document.getElementById('tabs-content');
        const dashboardSubtitle = document.getElementById('dashboard-subtitle');
        const manageBtn = document.getElementById('manage-btn');
        const exportBtn = document.getElementById('export-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const managementModal = document.getElementById('management-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalYearSelect = document.getElementById('modal-year-select');
        const modalMonthSelect = document.getElementById('modal-month-select');
        const modalFormContent = document.getElementById('modal-form-content');

        // ========================================================================
        // HELPER & UTILITY FUNCTIONS
        // ========================================================================

        const formatCurrency = (value) => {
            if (typeof value !== 'number') return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        };
        
        const getInitialMonthData = () => JSON.parse(JSON.stringify({
            'Procesos Internos': { 
                'Satisfacción Entrega de Equipos': { value: 0, meta: 90, unit: '%', type: 'percentage' }, 
                'Costo de Alisto BCP': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, 
                'Costo de Alisto CAT': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, 
                'Costo de Alisto JD': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, 
            },
            'Inventario': {
                'Rotación Caterpillar': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación John Deere': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación International': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación Mack': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación Volvo': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación Metso': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                'Rotación Otras Marcas': { value: 0, meta: 2, unit: 'x', type: 'rotacion' },
                // Raw inventory data (these will be used to calculate percentages)
                'Inventario Caterpillar Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Caterpillar Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario John Deere Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario John Deere Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario International Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario International Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Mack Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Mack Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Volvo Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Volvo Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Metso Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
                'Inventario Metso Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' },
            },
            'Participación': { 'Participación Caterpillar PINS': { matra: 0, industria: 0, meta: 30, unit: '%', type: 'market_share' }, 'Participación John Deere': { matra: 0, industria: 0, meta: 25, unit: '%', type: 'market_share' }, 'Participación Mack Clase 8': { matra: 0, industria: 0, meta: 20, unit: '%', type: 'market_share' }, 'Participación International': { matra: 0, industria: 0, meta: 18, unit: '%', type: 'market_share' }, },
            'Ventas': { 'Agrícola': { ventas: 0, ventas_nuevas: 0, meta: 280000, type: 'venta_sector' }, 'Construcción': { ventas: 0, ventas_nuevas: 0, meta: 420000, type: 'venta_sector' }, 'Distribución': { ventas: 0, ventas_nuevas: 0, meta: 150000, type: 'venta_sector' }, 'Gobierno': { ventas: 0, ventas_nuevas: 0, meta: 75000, type: 'venta_sector' }, 'Heavy Rent': { ventas: 0, ventas_nuevas: 0, meta: 60000, type: 'venta_sector' }, },
            'Utilidad': { 'Agrícola': { uop: 0, meta: 28000, type: 'utilidad_sector' }, 'Construcción': { uop: 0, meta: 45000, type: 'utilidad_sector' }, 'Distribución': { uop: 0, meta: 18000, type: 'utilidad_sector' }, 'Gobierno': { uop: 0, meta: 8000, type: 'utilidad_sector' }, 'Heavy Rent': { uop: 0, meta: 7500, type: 'utilidad_sector' }, },
            'Cobertura': { 'Cobertura Construcción': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Agrícola': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Distribución': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Gobierno': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' } },
            // Store raw data for derived KPIs (not displayed directly as tabs)
            'Datos de Origen': { 
                'Equipos con CSA': { unidades_con_csa: 0, unidades_totales_cat_sem: 0, type: 'csa_raw' },
                'NLS Mensual': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' },
                'NLS Rolling 6': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' }
            }
        }));

        const getKPIStatus = (kpi) => {
            if (!kpi) return 'N/A';
            
            // Custom logic for new KPI types
            if (kpi.type === 'new_client_percentage') {
                if (kpi.value > 30) return 'Bueno';
                if (kpi.value >= 25) return 'Regular';
                return 'Malo';
            }
            if (kpi.type === 'cobertura_percentage') {
                if (kpi.value > 90) return 'Bueno';
                if (kpi.value >= 80) return 'Regular';
                return 'Malo';
            }
            if (kpi.type === 'rotacion') {
                if (kpi.value > 2) return 'Bueno';
                if (kpi.value >= 1.6 && kpi.value <= 2) return 'Regular';
                if (kpi.value < 1.6) return 'Malo';
                return 'N/A'; // Should not happen with valid input
            }
            if (kpi.type === 'inventory_percentage') {
                // Lower is better, so this is an inverted goal
                if (kpi.value < kpi.meta) return 'Bueno';
                if (kpi.value < kpi.meta * 1.5) return 'Regular'; // Up to 50% over meta
                return 'Malo';
            }
            if (kpi.type === 'csa_percentage') {
                if (kpi.value > 85) return 'Bueno';
                if (kpi.value >= 60) return 'Regular';
                return 'Malo';
            }
            if (kpi.type === 'nls_percentage') {
                if (kpi.value > 72) return 'Bueno';
                if (kpi.value >= 65) return 'Regular';
                return 'Malo';
            }

            let value, meta;
            // Handle existing types for generic percentage calculation
            if (kpi.type === 'venta_sector') { value = kpi.ventas; meta = kpi.meta; }
            else if (kpi.type === 'utilidad_sector') { value = kpi.uop; meta = kpi.meta; }
            else if (kpi.type === 'market_share') { value = kpi.industria > 0 ? (kpi.matra / kpi.industria) * 100 : 0; meta = kpi.meta; }
            else { value = kpi.value; meta = kpi.meta; } // Fallback for generic 'percentage' or 'ratio' types
            
            if (meta === 0 || meta === undefined) return 'N/A';
            const percentage = (value / meta) * 100;

            if (kpi.inverted) { // Applies to 'Costo de Alisto' and 'Inventory Percentage'
                if (value <= meta) return 'Bueno';
                if (value <= meta * 1.1) return 'Regular'; // 10% over target
                return 'Malo';
            }
            if (percentage >= 100) return 'Bueno';
            if (percentage >= 90) return 'Regular';
            return 'Malo';
        };

        const getStatusStyles = (status) => {
            const styles = {
                'Bueno': { badge: 'bg-green-100 text-green-700', icon: 'check-circle', color: 'text-green-600' },
                'Regular': { badge: 'bg-yellow-100 text-yellow-700', icon: 'alert-triangle', color: 'text-yellow-600' },
                'Malo': { badge: 'bg-red-100 text-red-700', icon: 'trending-down', color: 'text-red-600' },
                'N/A': { badge: 'bg-gray-100 text-gray-600', icon: 'help-circle', color: 'text-gray-500' }
            };
            return styles[status] || styles['N/A'];
        };

        // ========================================================================
        // DATA HANDLING & PREPARATION
        // ========================================================================

        // populateInitialData is no longer needed as a separate function for loading/simulating data.
        // Its content (the data structure) is directly used by getInitialMonthData()

        function getPreviousMonth(year, month) {
            const monthIndex = state.months.indexOf(month);
            if (monthIndex === 0) {
                return { year: String(parseInt(year) - 1), month: state.months[11] };
            }
            return { year, month: state.months[monthIndex - 1] };
        }

        async function getDataForDisplay(options = {}) { // Made async
            const { year: queryYear = state.selectedYear, month: queryMonth = state.selectedMonth, ignoreFilters = false } = options;
            const dateKey = `${queryYear}-${queryMonth}`;
            
            // Start with a fresh initial data structure for the month
            let rawMonthData = JSON.parse(JSON.stringify(getInitialMonthData())); 

            try {
                // Try to get the document from Firestore
                const docRef = firebase_doc(db, 'kpis_por_mes', dateKey);
                const docSnap = await firebase_getDoc(docRef);

                if (docSnap.exists()) {
                    // If data exists in Firestore, merge it with the initial structure
                    const fetchedData = docSnap.data();
                    Object.keys(rawMonthData).forEach(category => {
                        if (fetchedData[category]) {
                            // Ensure nested objects also exist in rawMonthData before merging
                            rawMonthData[category] = rawMonthData[category] || {};
                            Object.keys(rawMonthData[category]).forEach(kpiName => {
                                if (fetchedData[category][kpiName]) {
                                    rawMonthData[category][kpiName] = rawMonthData[category][kpiName] || {};
                                    Object.assign(rawMonthData[category][kpiName], fetchedData[category][kpiName]);
                                }
                            });
                        }
                    });
                } else {
                    console.log(`No se encontraron datos para ${dateKey} en Firestore. Inicializando y guardando plantilla.`);
                    // If no data, save the initial template to Firestore
                    await firebase_setDoc(docRef, rawMonthData);
                }
            } catch (error) {
                console.error("Error al obtener o guardar el documento de Firestore:", error);
                // alert("No se pudieron cargar/inicializar los datos de la base de datos. Revisa tu conexión a internet y las reglas de Firebase."); // Commented out to avoid multiple alerts
            }

            // Update local state with fetched (or initialized) data
            state.kpiDataByDate[queryYear] = state.kpiDataByDate[queryYear] || {};
            state.kpiDataByDate[queryYear][queryMonth] = rawMonthData;

            // --- Dynamically create calculated KPIs based on rawMonthData ---
            // This 'currentData' will be the one used for display and further calculations
            const currentDataForDisplay = JSON.parse(JSON.stringify(rawMonthData)); 

            // Calculated "Clientes Nuevos"
            const newClientsKpis = {};
            const sectorsForNewClients = ['Agrícola', 'Construcción', 'Distribución'];
            let totalVentas = 0;
            let totalVentasNuevas = 0;

            Object.entries(currentDataForDisplay.Ventas).forEach(([sector, data]) => {
                totalVentas += data.ventas || 0;
                totalVentasNuevas += data.ventas_nuevas || 0;

                if (sectorsForNewClients.includes(sector)) {
                    newClientsKpis[`Clientes Nuevos ${sector}`] = {
                        value: (data.ventas || 0) > 0 ? ((data.ventas_nuevas || 0) / data.ventas) * 100 : 0,
                        meta: 30, unit: '%', type: 'new_client_percentage'
                    };
                }
            });
            newClientsKpis['Clientes Nuevos Ventas'] = {
                value: totalVentas > 0 ? (totalVentasNuevas / totalVentas) * 100 : 0,
                meta: 30, unit: '%', type: 'new_client_percentage'
            };
            currentDataForDisplay['Clientes Nuevos'] = newClientsKpis;
            
            // Calculated Inventory percentages
            const consolidatedInventory = {};
            const inventoryData = rawMonthData['Inventario'] || {}; // Use rawMonthData for raw inputs

            Object.entries(inventoryData).forEach(([name, data]) => {
                if (data.type === 'rotacion') {
                    consolidatedInventory[name] = data; // Keep rotation as is
                } else if (data.type === 'inventory') { // These are the raw inventory inputs
                    const cleanName = name.replace('Inventario ', '');
                    // Create derived KPIs for inventory percentage > 12 months
                    consolidatedInventory[`Inv. > 12m - ${cleanName}`] = {
                        value: (data.total || 0) > 0 ? ((data.mayor_12_meses || 0) / data.total) * 100 : 0,
                        meta: 10, unit: '%', type: 'inventory_percentage', inverted: true
                    };
                    // Create derived KPIs for inventory percentage > 24 months
                    consolidatedInventory[`Inv. > 24m - ${cleanName}`] = {
                        value: (data.total || 0) > 0 ? ((data.mayor_24_meses || 0) / data.total) * 100 : 0,
                        meta: 5, unit: '%', type: 'inventory_percentage', inverted: true
                    };
                }
            });
            currentDataForDisplay['Inventario'] = consolidatedInventory; // Replace raw inventory with calculated ones for display


            // Calculated CSA and NLS percentages from "Datos de Origen"
            const csaData = rawMonthData['Datos de Origen']?.['Equipos con CSA'];
            if(csaData) {
                currentDataForDisplay['Procesos Internos']['Equipos con CSA'] = {
                    value: (csaData.unidades_totales_cat_sem || 0) > 0 ? ((csaData.unidades_con_csa || 0) / csaData.unidades_totales_cat_sem) * 100 : 0,
                    meta: 85, unit: '%', type: 'csa_percentage'
                };
            }
            
            const nlsMensualData = rawMonthData['Datos de Origen']?.['NLS Mensual'];
            if(nlsMensualData) {
                currentDataForDisplay['Procesos Internos']['NLS Mensual'] = {
                    value: (nlsMensualData.encuestas_totales || 0) > 0 ? (((nlsMensualData.leales || 0) - (nlsMensualData.riesgo || 0)) / nlsMensualData.encuestas_totales) * 100 : 0,
                    meta: 72, unit: '%', type: 'nls_percentage'
                };
            }
            
            const nlsRollingData = rawMonthData['Datos de Origen']?.['NLS Rolling 6'];
            if(nlsRollingData) {
                currentDataForDisplay['Procesos Internos']['NLS Rolling 6'] = {
                    value: (nlsRollingData.encuestas_totales || 0) > 0 ? (((nlsRollingData.leales || 0) - (nlsRollingData.riesgo || 0)) / nlsRollingData.encuestas_totales) * 100 : 0,
                    meta: 72, unit: '%', type: 'nls_percentage'
                };
            }

            // Prepare all KPIs for filtering and grouping
            let allKpis = Object.entries(currentDataForDisplay).flatMap(([category, kpis]) => {
                // Exclude the raw 'Datos de Origen' category from being displayed as a tab or KPI
                if (category === 'Datos de Origen') return []; 
                if (category === 'Ventas' || category === 'Utilidad') {
                    // For Sales and Utility, ensure we create KPIs like "Ventas Agrícola"
                    return Object.entries(kpis).map(([sector, kpi]) => ({ name: `${category} ${sector}`, kpi, category }));
                }
                return Object.entries(kpis).map(([name, kpi]) => ({ name, kpi, category }));
            });

            // Apply filters if not ignored (e.g., for chat queries)
            if (!ignoreFilters) {
                // Filter by sector
                if (state.selectedSector !== 'todos') {
                    const sectorKeywords = { 'Agrícola': ['John Deere', 'JD', 'Agrícola', 'Inventario John Deere', 'Cobertura Agrícola'], 'Construcción': ['Caterpillar', 'CAT', 'Metso', 'Mack', 'Construcción', 'BCP', 'CSA', 'Inventario Caterpillar', 'Inventario Metso', 'Cobertura Construcción'], 'Distribución': ['International', 'Distribución', 'Volvo', 'Inventario International', 'Inventario Mack', 'Inventario Volvo', 'Cobertura Distribución'], 'Gobierno': ['Gobierno', 'Cobertura Gobierno'], 'Heavy Rent': ['Heavy Rent'] };
                    const keywords = sectorKeywords[state.selectedSector] || [];
                    allKpis = allKpis.filter(({ name, category }) => {
                        // Special handling for "Ventas" and "Utilidad" categories which include sector in their name directly
                        if ((category === 'Ventas' || category === 'Utilidad' || category === 'Cobertura') && name.includes(state.selectedSector)) return true;
                        // For other categories, check if the KPI name contains any of the sector keywords
                        return keywords.some(keyword => name.toLowerCase().includes(keyword.toLowerCase()));
                    });
                }

                // Filter by status
                if (state.filterStatus !== 'todos') {
                    allKpis = allKpis.filter(item => getKPIStatus(item.kpi).toLowerCase() === state.filterStatus.toLowerCase());
                }
            }
            
            // Group filtered KPIs by category for display
            const groupedData = allKpis.reduce((acc, { name, kpi, category }) => {
                if (!acc[category]) acc[category] = {};
                acc[category][name] = kpi;
                return acc;
            }, {});

            return {
                currentData: currentDataForDisplay, // This contains all raw and derived KPIs
                filteredData: groupedData, // This contains only filtered and grouped KPIs for display
                allKpis: allKpis // This contains all filtered KPIs as a flat array
            };
        }

        // ========================================================================
        // AUTHENTICATION
        // ========================================================================

        function handleLogin(event) {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            const user = users[username]; // Access local users object

            if (user && user.password === password) {
                state.currentUser = user;
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedUser', username);
                } else {
                    localStorage.removeItem('rememberedUser');
                }
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                initDashboard(); // Call async initDashboard
            } else {
                loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            state.currentUser = null;
            dashboardPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
            setupLoginPage();
            loginForm.reset();
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                usernameInput.value = rememberedUser;
            }
        }

        function setupLoginPage() {
            const rememberedUser = localStorage.getItem('rememberedUser');
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            let greetingHtml = '';

            if (rememberedUser && users[rememberedUser]) {
                const user = users[rememberedUser];
                greetingHtml = `
                    <h1 class="text-3xl font-bold text-white">Hola, ${user.firstName}</h1>
                    <p class="mt-2 text-sm text-gray-300">¡Qué bueno verte de nuevo!</p>
                    <p class="mt-4 text-sm text-yellow-400 italic">"${randomQuote}"</p>
                `;
                usernameInput.value = rememberedUser;
                rememberMeCheckbox.checked = true;
            } else {
                greetingHtml = `
                    <p class="mt-2 text-lg text-gray-200">Dashboard de Ventas - Balanced Scorecard<br>Ingrese para continuar.</p>
                    <p class="mt-4 text-sm text-yellow-400 italic">"${randomQuote}"</p>
                `;
            }
            loginGreeting.innerHTML = greetingHtml;
        }

        // ========================================================================
        // RENDERING & UI UPDATES
        // ========================================================================

        function destroyAllCharts() {
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            state.charts = {};
        }

        async function renderDashboard() { // Made async
            destroyAllCharts();
            dashboardSubtitle.textContent = `Mostrando datos para ${state.selectedMonth} ${state.selectedYear}.`;
            // Access control for manage button
            if (state.currentUser && state.currentUser.level === 'write') {
                manageBtn.style.display = 'inline-flex';
            } else {
                manageBtn.style.display = 'none';
            }
            await renderTabs(); // Await renderTabs as it now depends on data
            await renderTabContent(); // Now awaits the content to be loaded and rendered
        }

        async function renderTabs() { // Made async
            const { currentData } = await getDataForDisplay({ ignoreFilters: true }); // Get all categories, ignoring current filters
            const categoriesToDisplay = Object.keys(currentData).filter(cat => cat !== 'Datos de Origen'); // Exclude raw data category
            
            tabsList.innerHTML = `
                <button data-tab="dashboard" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'dashboard' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}">Dashboard</button>
                ${categoriesToDisplay.map(category => `
                    <button data-tab="${category}" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === category ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}">${category}</button>
                `).join('')}
                <button data-tab="pronostico" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'pronostico' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}">Pronóstico</button>
                <button data-tab="analisis-ia" class="px-4 py-2.5 text-sm font-medium whitespace-nowrap -mb-px border-b-2 transition-colors duration-200 ${state.selectedCategory === 'analisis-ia' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'}">Análisis IA</button>
            `;
            lucide.createIcons();
        }

        async function renderTabContent() { // Made async
            const { filteredData, allKpis, currentData } = await getDataForDisplay(); // Await data from Firestore
            tabsContent.innerHTML = ''; // Clear previous content

            if (state.selectedCategory === 'dashboard') {
                renderDashboardTab(allKpis);
            } else if (state.selectedCategory === 'pronostico') {
                renderForecastTab();
            } else if (state.selectedCategory === 'analisis-ia') {
                renderAITab(currentData);
            } else {
                const categoryData = filteredData[state.selectedCategory];
                if (categoryData && Object.keys(categoryData).length > 0) {
                    if(state.selectedCategory === 'Participación') {
                        renderMarketShareTab(categoryData);
                    } else {
                        renderKpiCategoryTab(categoryData, state.selectedCategory);
                    }
                } else {
                    tabsContent.innerHTML = `
                        <div class="text-center py-12 card">
                            <i data-lucide="search-x" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Sin resultados</h3>
                            <p class="mt-1 text-sm text-gray-500">No hay KPIs que coincidan con los filtros seleccionados en esta categoría.</p>
                        </div>`;
                    lucide.createIcons();
                }
            }
        }

        function createKpiCardElement(name, kpi, category) {
            const template = document.getElementById('kpi-card-template');
            const card = template.content.cloneNode(true);

            const status = getKPIStatus(kpi);
            const styles = getStatusStyles(status);
            
            const { year: prevYear, month: prevMonth } = getPreviousMonth(state.selectedYear, state.selectedMonth);
            // Get previous month's raw data for accurate trend calculation
            // This is awaited in the renderDashboard -> renderTabContent call chain, so should be available in state.kpiDataByDate
            const { allKpis: prevAllKpis } = getDataForDisplay({ year: prevYear, month: prevMonth, ignoreFilters: true });
            const prevKpiFound = prevAllKpis.find(item => item.name === name);
            const prevKpi = prevKpiFound ? prevKpiFound.kpi : null;


            let displayValue, prevValue, valueForTrend;
            
            // Determine display value
            if (kpi.type === 'venta_sector' || kpi.type === 'utilidad_sector') {
                displayValue = formatCurrency(kpi.ventas || kpi.uop);
            } else if (kpi.unit === '%') {
                displayValue = `${(kpi.value || 0).toFixed(1)}%`;
            } else if (kpi.unit === 'x') {
                displayValue = `${(kpi.value || 0).toFixed(2)}${kpi.unit}`;
            } else {
                displayValue = `${kpi.value?.toFixed(1) || 0}${kpi.unit || ''}`;
            }

            // Determine value for trend comparison (current and previous)
            if (kpi.type === 'venta_sector') {
                valueForTrend = kpi.ventas || 0;
                prevValue = prevKpi ? (prevKpi.ventas || 0) : 0;
            } else if (kpi.type === 'utilidad_sector') {
                valueForTrend = kpi.uop || 0;
                prevValue = prevKpi ? (prevKpi.uop || 0) : 0;
            } else if (kpi.type === 'market_share') {
                valueForTrend = (kpi.industria || 0) > 0 ? ((kpi.matra || 0) / kpi.industria) * 100 : 0;
                prevValue = prevKpi && (prevKpi.industria || 0) > 0 ? ((prevKpi.matra || 0) / prevKpi.industria) * 100 : 0;
            } else { // Handles percentage, ratio, rotacion, inventory, csa, nls types
                valueForTrend = kpi.value || 0;
                prevValue = prevKpi ? (prevKpi.value || 0) : 0;
            }
            
            const difference = valueForTrend - prevValue;
            let trendHtml = '';
            if (difference > 0.01) {
                trendHtml = `<i data-lucide="trending-up" class="w-3 h-3 mr-1 text-green-600"></i>+${difference.toFixed(1)}${kpi.unit === '%' ? '%' : ''} vs mes anterior`;
            } else if (difference < -0.01) {
                trendHtml = `<i data-lucide="trending-down" class="w-3 h-3 mr-1 text-red-600"></i>${difference.toFixed(1)}${kpi.unit === '%' ? '%' : ''} vs mes anterior`;
            } else {
                trendHtml = `<i data-lucide="minus" class="w-3 h-3 mr-1 text-gray-500"></i>Sin cambios`;
            }
            
            card.querySelector('.kpi-title').textContent = name;
            card.querySelector('.kpi-status-badge').textContent = status;
            card.querySelector('.kpi-status-badge').className = `kpi-status-badge mt-1 inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full ${styles.badge}`;
            card.querySelector('.kpi-value').textContent = displayValue;
            // Adjust meta display for inventory percentages and others
            if (kpi.type === 'inventory_percentage' || kpi.type === 'csa_percentage' || kpi.type === 'nls_percentage' || kpi.type === 'new_client_percentage' || kpi.type === 'cobertura_percentage') {
                 card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta}${kpi.unit || ''}`;
            } else if (kpi.type.includes('sector')) { // Venta y Utilidad
                card.querySelector('.kpi-meta').textContent = `Meta: ${formatCurrency(kpi.meta)}`;
            } else if (kpi.unit) {
                card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta}${kpi.unit}`;
            } else {
                 card.querySelector('.kpi-meta').textContent = `Meta: ${kpi.meta || 'N/A'}`; // Fallback for undefined meta
            }

            card.querySelector('.kpi-trend').innerHTML = trendHtml;
            
            if (kpi.type === 'utilidad_sector') {
                const achievement = (kpi.meta || 0) > 0 ? ((kpi.uop || 0) / kpi.meta) * 100 : 0;
                const colorClass = achievement >= 100 ? 'text-green-600' : achievement >= 90 ? 'text-yellow-600' : 'text-red-600';
                card.querySelector('.kpi-achievement').innerHTML = `<div class="text-sm font-bold ${colorClass}">${achievement.toFixed(1)}% Logro</div>`;
            } else if (kpi.type === 'venta_sector') {
                const achievement = (kpi.meta || 0) > 0 ? ((kpi.ventas || 0) / kpi.meta) * 100 : 0;
                const colorClass = achievement >= 100 ? 'text-green-600' : achievement >= 90 ? 'text-yellow-600' : 'text-red-600';
                card.querySelector('.kpi-achievement').innerHTML = `<div class="text-sm font-bold ${colorClass}">${achievement.toFixed(1)}% Logro</div>`;
            } else if (kpi.type === 'market_share' || kpi.type === 'percentage' || kpi.type === 'new_client_percentage' || kpi.type === 'cobertura_percentage' || kpi.type === 'csa_percentage' || kpi.type === 'nls_percentage') {
                const achievement = (kpi.meta || 0) > 0 ? ((kpi.value || 0) / kpi.meta) * 100 : 0;
                let colorClass;
                if (kpi.inverted) { // For inverted percentages (e.g., lower is better)
                    if ((kpi.value || 0) < kpi.meta) colorClass = 'text-green-600'; // Better than meta
                    else if ((kpi.value || 0) < kpi.meta * 1.5) colorClass = 'text-yellow-600'; // Within 50% over meta
                    else colorClass = 'text-red-600'; // Much over meta
                } else {
                    if (achievement >= 100) colorClass = 'text-green-600';
                    else if (achievement >= 90) colorClass = 'text-yellow-600';
                    else colorClass = 'text-red-600';
                }
                card.querySelector('.kpi-achievement').innerHTML = `<div class="text-sm font-bold ${achievement.toFixed(1)}% Logro</div>`;
            }


            const chartCanvas = card.querySelector('.kpi-sparkline-chart');
            chartCanvas.id = `sparkline-chart-${name.replace(/\s+/g, '-')}`; 

            return card;
        }

        async function initializeKpiCardChart(name, kpi, category) {
            const chartId = `sparkline-chart-${name.replace(/\s+/g, '-')}`;
            const chartCanvas = document.getElementById(chartId);

            if (!chartCanvas) {
                console.error(`Canvas with id ${chartId} not found.`);
                return;
            }

            const sequence = getMonthSequence(state.selectedYear, state.selectedMonth, 12);
            const historyData = await Promise.all(sequence.map(async ({year, month}) => {
                // Get the *processed* data (with calculated KPIs) for each month in the sequence
                const { currentData: historicalDataPoint } = await getDataForDisplay({ year, month, ignoreFilters: true });
                
                // Find the specific KPI within the processed data for this historical month
                let historicalKpi = null;
                if (category === 'Ventas' || category === 'Utilidad') {
                    const sectorName = name.replace(`${category} `, '');
                    historicalKpi = historicalDataPoint[category]?.[sectorName];
                } else {
                    historicalKpi = historicalDataPoint[category]?.[name];
                }

                if (!historicalKpi) return 0; 

                if (historicalKpi.type === 'venta_sector') return historicalKpi.ventas || 0;
                if (historicalKpi.type === 'utilidad_sector') return historicalKpi.uop || 0;
                if (historicalKpi.type === 'market_share') return (historicalKpi.industria || 0) > 0 ? ((historicalKpi.matra || 0) / historicalKpi.industria) * 100 : 0;
                
                // For all other types that use 'value' (percentage, ratio, rotacion, inventory, csa, nls)
                return historicalKpi.value || 0;
            }));

            state.charts[`sparkline-${name}`] = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sequence.map(s => s.month.substring(0,3)),
                    datasets: [{
                        data: historyData,
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#111827',
                            titleFont: { size: 12 },
                            bodyFont: { size: 12 },
                            padding: 8,
                            displayColors: false,
                            callbacks: {
                                title: () => name, // KPI Name as title
                                label: function(context) {
                                    const monthLabel = context.label;
                                    let value = context.parsed.y;
                                    let formattedValue = '';

                                    // Logic to format the value based on KPI type
                                    if (kpi.type.includes('sector')) { // Venta y Utilidad
                                        formattedValue = formatCurrency(value);
                                    } else if (kpi.unit === '%') {
                                        formattedValue = `${value.toFixed(1)}%`;
                                    } else if (kpi.unit === 'x') {
                                        formattedValue = `${value.toFixed(2)}${kpi.unit}`;
                                    } else {
                                        formattedValue = `${value.toFixed(1)}${kpi.unit || ''}`;
                                    }
                                    
                                    return `${monthLabel}: ${formattedValue}`;
                                }
                            }
                        }
                    },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        async function renderKpiCategoryTab(categoryData, categoryName) { // Made async
            const container = document.createElement('div');
            container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            
            Object.entries(categoryData).forEach(([name, kpi]) => {
                container.appendChild(createKpiCardElement(name, kpi, categoryName));
            });
            
            tabsContent.appendChild(container);
            
            // Delay chart initialization to ensure canvases are in DOM
            await new Promise(resolve => setTimeout(resolve, 0)); 
            
            for (const [name, kpi] of Object.entries(categoryData)) {
                await initializeKpiCardChart(name, kpi, categoryName);
            }
            lucide.createIcons();
        }
        
        async function renderMarketShareTab(categoryData) { // Made async
            const container = document.createElement('div');
            container.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';
            const chartInfo = [];

            for (const [name, kpi] of Object.entries(categoryData)) { // Using for...of with await
                const brand = name.replace('Participación ', '');
                const chartData = await Promise.all(state.months.map(async month => { // Map also made async
                    const monthRawData = state.kpiDataByDate[state.selectedYear]?.[month];
                    if (!monthRawData) return { mes: month.substring(0,3), industria: 0, matra: 0, marketShare: 0 };
                    
                    const monthKpi = monthRawData['Participación']?.[name];
                    if (!monthKpi) return { mes: month.substring(0,3), industria: 0, matra: 0, marketShare: 0 };

                    return {
                        mes: month.substring(0,3),
                        industria: monthKpi.industria || 0,
                        matra: monthKpi.matra || 0,
                        marketShare: (monthKpi.industria || 0) > 0 ? (monthKpi.matra / monthKpi.industria) * 100 : 0
                    };
                }));
                chartInfo.push({ brand, chartData });
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="p-4 md:p-6">
                        <h3 class="text-lg font-semibold">Participación de Mercado: ${brand}</h3>
                        <p class="text-sm text-gray-500">Unidades Matra vs. Total Industria (${state.selectedYear})</p>
                    </div>
                    <div class="p-4 md:p-6 pt-0">
                        <div style="height: 250px;">
                            <canvas id="market-share-chart-${brand.replace(/\s+/g, '')}"></canvas>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
            tabsContent.appendChild(container);

            await new Promise(resolve => setTimeout(resolve, 0)); // Ensure canvases are in DOM
            
            chartInfo.forEach(({ brand, chartData }) => {
                const ctx = document.getElementById(`market-share-chart-${brand.replace(/\s+/g, '')}`).getContext('2d');
                state.charts[`market-share-${brand}`] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.mes),
                        datasets: [
                            { label: 'Industria', data: chartData.map(d => d.industria), backgroundColor: '#d1d5db', yAxisID: 'y' },
                            { label: 'Matra', data: chartData.map(d => d.matra), backgroundColor: '#4b5563', yAxisID: 'y' },
                            { label: 'Market Share', data: chartData.map(d => d.marketShare), type: 'line', borderColor: '#f97316', tension: 0.1, yAxisID: 'y1', borderWidth: 2 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Unidades' } },
                            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Market Share (%)' } }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (tooltipItems) => `Mes: ${tooltipItems[0].label}`,
                                    label: (context) => '',
                                    afterBody: (tooltipItems) => {
                                        const index = tooltipItems[0].dataIndex;
                                        const dataPoint = chartData[index];
                                        return [
                                            `Industria: ${dataPoint.industria.toLocaleString()}`,
                                            `Matra: ${dataPoint.matra.toLocaleString()}`,
                                            `% MS: ${dataPoint.marketShare.toFixed(2)}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        async function renderDashboardTab(allKpis) { // Made async
            const statusGroups = { Bueno: [], Regular: [], Malo: [], 'N/A': [] };
            allKpis.forEach(item => {
                const status = getKPIStatus(item.kpi);
                statusGroups[status].push(item);
            });
            
            const sectorData = async (dataType) => { // Made async
                return await Promise.all(state.months.map(async month => { // Map also made async
                    // Ensure month data is loaded from Firestore before summing
                    const { currentData: monthData } = await getDataForDisplay({ year: state.selectedYear, month, ignoreFilters: true });
                    if (!monthData) return { value: 0, meta: 0 };
                    
                    let totalValue = 0, totalMeta = 0;
                    const sectorsToSum = state.selectedSector === 'todos' ? state.sectors : [state.selectedSector];
                    
                    sectorsToSum.forEach(sector => {
                        const data = monthData[dataType]?.[sector]; // Use optional chaining
                        if(data) {
                            totalValue += (dataType === 'Ventas' ? (data.ventas || 0) : (data.uop || 0));
                            totalMeta += (data.meta || 0);
                        }
                    });
                    return { value: totalValue, meta: totalMeta };
                }));
            };

            const salesData = await sectorData('Ventas'); // Await data
            const utilityData = await sectorData('Utilidad'); // Await data

            tabsContent.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6"><div style="height: 250px;"><canvas id="sales-trend-chart"></canvas></div></div>
                        <div class="card p-6"><div style="height: 250px;"><canvas id="utility-trend-chart"></canvas></div></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold">Desglose de KPIs por Estado</h3>
                        <p class="text-sm text-gray-500">Lista de KPIs clasificados según su rendimiento actual.</p>
                        <div id="kpi-status-lists" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4"></div>
                    </div>
                </div>
            `;
            
            // Delay chart initialization to ensure canvases are in DOM
            await new Promise(resolve => setTimeout(resolve, 0)); 
            
            // --- Sales Chart Logic ---
            const salesValues = salesData.map(d => d.value);
            const maxSales = salesValues.length > 0 ? Math.max(...salesValues) : 0;
            const minSales = salesValues.filter(v => v > 0).length > 0 ? Math.min(...salesValues.filter(v => v > 0)) : 0;
            const maxSalesIndex = salesValues.indexOf(maxSales);
            const minSalesIndex = salesValues.indexOf(minSales);
            const salesBarColors = salesValues.map((val, index) => {
                if (index === maxSalesIndex) return '#0065a2';
                if (index === minSalesIndex && salesValues.length > 1) return '#e77577'; // Only highlight min if there's more than one value
                return '#bfdbfe';
            });
            const salesCtx = document.getElementById('sales-trend-chart').getContext('2d');
            state.charts.salesTrend = new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: state.months.map(m => m.substring(0,3)),
                    datasets: [
                        { label: 'Meta de Ventas', type: 'line', data: salesData.map(d => d.meta), borderColor: '#3b82f6', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: 'Ventas Reales', data: salesValues, backgroundColor: salesBarColors }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { 
                        title: { display: true, text: `Tendencia de Ventas ${state.selectedSector !== 'todos' ? `(${state.selectedSector})` : '(General)'}` },
                        tooltip: { callbacks: { footer: (tooltipItems) => {
                            const index = tooltipItems[0].dataIndex;
                            const real = salesData[index].value || 0;
                            const meta = salesData[index].meta || 0;
                            const achievement = meta > 0 ? (real / meta) * 100 : 0;
                            return `% de Logro: ${achievement.toFixed(1)}%`;
                        }}}
                    }, 
                    scales: { y: { ticks: { callback: value => formatCurrency(value) } } } 
                }
            });

            // --- Utility Chart Logic ---
            const utilityValues = utilityData.map(d => d.value);
            const maxUtility = utilityValues.length > 0 ? Math.max(...utilityValues) : 0;
            const minUtility = utilityValues.filter(v => v > 0).length > 0 ? Math.min(...utilityValues.filter(v => v > 0)) : 0;
            const maxUtilityIndex = utilityValues.indexOf(maxUtility);
            const minUtilityIndex = utilityValues.indexOf(minUtility);
            const utilityBarColors = utilityValues.map((val, index) => {
                if (index === maxUtilityIndex) return '#0065a2';
                if (index === minUtilityIndex && utilityValues.length > 1) return '#e77577';
                return '#99f6e4';
            });
            const utilityCtx = document.getElementById('utility-trend-chart').getContext('2d');
            state.charts.utilityTrend = new Chart(utilityCtx, {
                type: 'bar',
                data: {
                    labels: state.months.map(m => m.substring(0,3)),
                    datasets: [
                        { label: 'Meta de Utilidad', type: 'line', data: utilityData.map(d => d.meta), borderColor: '#14b8a6', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: 'Utilidad Real', data: utilityValues, backgroundColor: utilityBarColors }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { 
                        title: { display: true, text: `Tendencia de Utilidad Op. ${state.selectedSector !== 'todos' ? `(${state.selectedSector})` : '(General)'}` },
                        tooltip: { callbacks: { footer: (tooltipItems) => {
                            const index = tooltipItems[0].dataIndex;
                            const utility = utilityData[index].value || 0;
                            const sales = salesData[index].value || 0; // Need sales data for margin calculation
                            const margin = sales > 0 ? (utility / sales) * 100 : 0;
                            return `% Utilidad Op: ${margin.toFixed(1)}%`;
                        }}}
                    }, 
                    scales: { y: { ticks: { callback: value => formatCurrency(value) } } } 
                }
            });

            // Render status lists
            const listsContainer = document.getElementById('kpi-status-lists');
            listsContainer.innerHTML = '';
            Object.entries(statusGroups).forEach(([status, kpis]) => {
                if (kpis.length === 0) return; // Don't render empty groups
                const styles = getStatusStyles(status);
                const listHtml = kpis.map(item => {
                    const { year: prevYear, month: prevMonth } = getPreviousMonth(state.selectedYear, state.selectedMonth);
                    // Get previous month's processed data for accurate trend comparison
                    const { allKpis: prevAllKpisForStatusList } = getDataForDisplay({ year: prevYear, month: prevMonth, ignoreFilters: true });
                    const prevKpiFoundForStatusList = prevAllKpisForStatusList.find(elem => elem.name === item.name);
                    const prevKpiForStatusList = prevKpiFoundForStatusList ? prevKpiFoundForStatusList.kpi : null;

                    let displayValue, prevValue, valueForTrend;

                    // Determine display value
                    if (item.kpi.type === 'venta_sector' || item.kpi.type === 'utilidad_sector') {
                        displayValue = formatCurrency(item.kpi.ventas || item.kpi.uop);
                    } else if (item.kpi.unit === '%') {
                        displayValue = `${(item.kpi.value || 0).toFixed(1)}%`;
                    } else if (item.kpi.unit === 'x') {
                        displayValue = `${(item.kpi.value || 0).toFixed(2)}${item.kpi.unit}`;
                    } else {
                        displayValue = `${item.kpi.value?.toFixed(1) || 0}${item.kpi.unit || ''}`;
                    }
                    
                    // Determine value for trend comparison
                    if (item.kpi.type === 'venta_sector') {
                        valueForTrend = item.kpi.ventas || 0;
                        prevValue = prevKpiForStatusList ? (prevKpiForStatusList.ventas || 0) : 0;
                    } else if (item.kpi.type === 'utilidad_sector') {
                        valueForTrend = item.kpi.uop || 0;
                        prevValue = prevKpiForStatusList ? (prevKpiForStatusList.uop || 0) : 0;
                    } else if (item.kpi.type === 'market_share') {
                        valueForTrend = (item.kpi.industria || 0) > 0 ? ((item.kpi.matra || 0) / item.kpi.industria) * 100 : 0;
                        prevValue = prevKpiForStatusList && (prevKpiForStatusList.industria || 0) > 0 ? ((prevKpiForStatusList.matra || 0) / prevKpiForStatusList.industria) * 100 : 0;
                    } else { // Handles percentage, ratio, rotacion, inventory, csa, nls types
                        valueForTrend = item.kpi.value || 0;
                        prevValue = prevKpiForStatusList ? (prevKpiForStatusList.value || 0) : 0;
                    }
                    
                    const difference = valueForTrend - prevValue;
                    let trendIcon = '';
                    if (difference > 0.01) trendIcon = `<i data-lucide="trending-up" class="w-4 h-4 text-green-600"></i>`;
                    else if (difference < -0.01) trendIcon = `<i data-lucide="trending-down" class="w-4 h-4 text-red-600"></i>`;
                    else trendIcon = `<i data-lucide="minus" class="w-4 h-4 text-gray-500"></i>`;
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                            <div>
                                <p class="text-sm font-medium text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500">Valor: ${displayValue}</p>
                            </div>
                            ${trendIcon}
                        </div>
                    `;
                }).join('');

                listsContainer.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <button class="collapsible-trigger w-full flex items-center justify-between mb-4 text-left">
                            <div class="flex items-center">
                                <i data-lucide="${styles.icon}" class="w-5 h-5 ${styles.color}"></i>
                                <h4 class="ml-2 font-semibold text-lg">${status}</h4>
                            </div>
                            <div class="flex items-center">
                                <span class="mr-2 text-sm font-bold text-gray-500">${kpis.length}</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-600 transition-transform"></i>
                            </div>
                        </button>
                        <div class="collapsible-content open">
                            <div class="space-y-3 pt-2 border-t">
                                ${kpis.length > 0 ? listHtml : `<p class="text-sm text-gray-500 text-center py-4">No hay KPIs en este estado.</p>`}
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }
        
        async function renderForecastTab() { // Made async
            tabsContent.innerHTML = `
                <div class="card">
                    <div class="p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div>
                                <h3 class="text-lg font-semibold">Pronóstico de Ventas y Utilidad</h3>
                                <p class="text-sm text-gray-500">Proyección basada en tendencia histórica para el sector: <span class="font-semibold">${state.selectedSector === 'todos' ? 'General' : state.selectedSector}</span></p>
                            </div>
                            <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                                <label for="forecast-months" class="text-sm">Meses a Pronosticar:</label>
                                <input id="forecast-months-slider" type="range" min="1" max="12" value="6" class="w-32"/>
                                <span id="forecast-months-label" class="font-bold">6</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-md font-semibold mb-2">Ventas</h4>
                            <div style="height: 250px;"><canvas id="forecast-sales-chart"></canvas></div>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2">Utilidad Operativa</h4>
                            <div style="height: 250px;"><canvas id="forecast-utility-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            `;
            
            await new Promise(resolve => setTimeout(resolve, 0)); // Ensure elements are in DOM
            
            const slider = document.getElementById('forecast-months-slider');
            const label = document.getElementById('forecast-months-label');
            slider.addEventListener('input', async (e) => { // Made async
                label.textContent = e.target.value;
                await updateForecastCharts(parseInt(e.target.value));
            });
            await updateForecastCharts(6); // Initial call
        }

        async function updateForecastCharts(forecastMonths) { // Made async
            const linearRegression = (data) => {
                const n = data.length;
                if (n < 2) return (x) => data[0]?.y || 0;
                const sumX = data.reduce((acc, d) => acc + d.x, 0);
                const sumY = data.reduce((acc, d) => acc + d.y, 0);
                const sumXY = data.reduce((acc, d) => acc + d.x * d.y, 0);
                const sumXX = data.reduce((acc, d) => acc + d.x * d.x, 0);
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                if(isNaN(slope) || isNaN(intercept)) return (x) => data[data.length-1]?.y || 0;
                return (x) => Math.max(0, slope * x + intercept);
            };

            const getHistoricalData = async (dataType) => { // Made async
                return await Promise.all(state.months.map(async month => { // Map also made async
                    const { currentData: monthData } = await getDataForDisplay({ year: state.selectedYear, month, ignoreFilters: true }); // Get processed data
                    if (!monthData) return 0;
                    let totalValue = 0;
                    const sectorsToSum = state.selectedSector === 'todos' ? state.sectors : [state.selectedSector];
                    sectorsToSum.forEach(sector => {
                        const data = monthData[dataType]?.[sector];
                        if(data) totalValue += (dataType === 'Ventas' ? (data.ventas || 0) : (data.uop || 0));
                    });
                    return totalValue;
                }));
            };
            
            const historicalSales = await getHistoricalData('Ventas'); // Await data
            const historicalUtility = await getHistoricalData('Utilidad'); // Await data
            
            const salesPoints = historicalSales.map((y, x) => ({x, y}));
            const utilityPoints = historicalUtility.map((y, x) => ({x, y}));

            const salesRegression = linearRegression(salesPoints);
            const utilityRegression = linearRegression(utilityPoints);
            
            const forecastSales = Array.from({length: forecastMonths}, (_, i) => salesRegression(historicalSales.length + i));
            const forecastUtility = Array.from({length: forecastMonths}, (_, i) => utilityRegression(historicalUtility.length + i));
            
            const allLabels = [...state.months.map(m => m.substring(0,3))];
            const lastMonthIndex = state.months.length -1;
            for(let i=0; i<forecastMonths; i++) {
                allLabels.push(state.months[(lastMonthIndex + i + 1) % 12].substring(0,3));
            }

            const salesData = [...historicalSales, ...forecastSales];
            const utilityData = [...historicalUtility, ...forecastUtility];

            const renderChart = (id, chartName, data, historicalData, color) => {
                const ctx = document.getElementById(id).getContext('2d');
                if (state.charts[id]) state.charts[id].destroy();
                state.charts[id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels.slice(0, data.length),
                        datasets: [
                            { label: 'Histórico', data: historicalData, borderColor: color, tension: 0.1, borderWidth: 2 },
                            { label: 'Pronóstico', data: Array(historicalData.length-1).fill(null).concat(data.slice(historicalData.length-1)), borderColor: color, borderDash: [5, 5], tension: 0.1, borderWidth: 2 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } } } }
                });
            };

            renderChart('forecast-sales-chart', 'Ventas', salesData, historicalSales, '#3b82f6');
            renderChart('forecast-utility-chart', 'Utilidad Operativa', utilityData, historicalUtility, '#14b8a6');
        }
        
        async function renderAITab(currentData) { // Made async (though currentData is already fetched)
            tabsContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card lg:col-span-1">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="sparkles" class="text-yellow-500"></i>Análisis General del Mes</h3>
                            <p class="text-sm text-gray-500">Resumen y recomendaciones generadas por IA para ${state.selectedMonth} ${state.selectedYear}.</p>
                        </div>
                        <div class="p-6">
                            <button id="generate-ai-analysis-btn" class="w-full btn btn-primary gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i>Generar Análisis</button>
                            <div id="ai-analysis-content" class="mt-4 prose prose-sm max-w-none text-gray-700"></div>
                        </div>
                    </div>
                    <div class="card lg:col-span-1 flex flex-col">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="brain-circuit" class="text-purple-500"></i>Chat de Datos</h3>
                            <p class="text-sm text-gray-500">Pregúntale a la IA sobre los datos del mes actual.</p>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <div id="chat-history" class="flex-1 overflow-y-auto bg-gray-100 p-4 rounded-md space-y-4 h-64 border border-gray-200">
                                <div class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                                    <i data-lucide="brain-circuit" class="w-10 h-10 mb-2"></i>
                                    <p>Haz una pregunta para empezar.</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t">
                            <div class="flex w-full space-x-2">
                                <input id="chat-input" type="text" placeholder="Ej: ¿Cuál fue la utilidad de Construcción?" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"/>
                                <button id="chat-submit-btn" class="btn bg-purple-600 text-white hover:bg-purple-700 disabled:bg-purple-300"><i data-lucide="send" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();

            document.getElementById('generate-ai-analysis-btn').addEventListener('click', () => generateAIAnalysis()); // Removed currentData param
            document.getElementById('chat-submit-btn').addEventListener('click', () => handleChatSubmit());
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatSubmit();
            });
        }
        
        async function generateAIAnalysis() { // Made async, now calls getDataForDisplay
            const btn = document.getElementById('generate-ai-analysis-btn');
            const contentDiv = document.getElementById('ai-analysis-content');
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Generando...</span>`;
            contentDiv.innerHTML = `<div class="mt-4 text-center text-gray-500 animate-pulse">Analizando datos...</div>`;
            
            // Get data for general analysis (ignoring current filters)
            const { currentData: rawDataForAnalysis, allKpis: allCalculatedKpis } = await getDataForDisplay({ ignoreFilters: true });

            setTimeout(() => {
                let summary = `<strong>Análisis para ${state.selectedMonth} ${state.selectedYear}:</strong><ul>`;

                // General Sales and Utility analysis
                const totalSales = Object.values(rawDataForAnalysis.Ventas).reduce((sum, s) => sum + (s.ventas || 0), 0);
                const totalSalesMeta = Object.values(rawDataForAnalysis.Ventas).reduce((sum, s) => sum + (s.meta || 0), 0);
                const totalUtility = Object.values(rawDataForAnalysis.Utilidad).reduce((sum, u) => sum + (u.uop || 0), 0);
                const totalUtilityMeta = Object.values(rawDataForAnalysis.Utilidad).reduce((sum, u) => sum + (u.meta || 0), 0);
                
                summary += `<li><strong>Resumen General:</strong> El rendimiento general de ${state.selectedMonth} ${state.selectedYear} ha sido `;
                if (totalSales >= totalSalesMeta * 0.95 && totalUtility >= totalUtilityMeta * 0.95) {
                    summary += `**sólido** con ventas y utilidad cerca o por encima de las metas.`;
                } else if (totalSales >= totalSalesMeta * 0.8 && totalUtility >= totalUtilityMeta * 0.8) {
                    summary += `**aceptable**, pero hay áreas con oportunidad de mejora.`;
                } else {
                    summary += `**desafiante**, requiriendo atención en varios frentes.`;
                }
                summary += ` (Ventas: ${formatCurrency(totalSales)} / Meta: ${formatCurrency(totalSalesMeta)} | Utilidad: ${formatCurrency(totalUtility)} / Meta: ${formatCurrency(totalUtilityMeta)}).</li>`;


                // Analyze key areas based on their status (Buen, Regular, Malo)
                const goodKpis = allCalculatedKpis.filter(k => getKPIStatus(k.kpi) === 'Bueno');
                const regularKpis = allCalculatedKpis.filter(k => getKPIStatus(k.kpi) === 'Regular');
                const badKpis = allCalculatedKpis.filter(k => getKPIStatus(k.kpi) === 'Malo');

                if (goodKpis.length > 0) {
                    summary += `<li><strong>Puntos Fuertes:</strong> Se destaca el buen desempeño en: ${goodKpis.map(k => {
                        let val = k.kpi.value ?? k.kpi.ventas ?? k.kpi.uop ?? '';
                        let unit = k.kpi.unit || '';
                        if (typeof val === 'number' && k.type && k.type.includes('sector')) val = formatCurrency(val);
                        else if (typeof val === 'number') val = val.toFixed(1);
                        return `**${k.name}** (${val}${unit})`;
                    }).join(', ')}. Estos indicadores superaron las expectativas.</li>`;
                }
                if (badKpis.length > 0) {
                    summary += `<li><strong>Áreas de Oportunidad (Requieren Atención):</strong> Se identifican desafíos en: ${badKpis.map(k => {
                        let val = k.kpi.value ?? k.kpi.ventas ?? k.kpi.uop ?? '';
                        let unit = k.kpi.unit || '';
                        if (typeof val === 'number' && k.type && k.type.includes('sector')) val = formatCurrency(val);
                        else if (typeof val === 'number') val = val.toFixed(1);
                        return `**${k.name}** (${val}${unit})`;
                    }).join(', ')}. Es crucial analizar las causas y desarrollar planes de acción.`;
                    // Specific recommendation for top 'Malo' KPI
                    const firstBadKpi = badKpis[0];
                    if (firstBadKpi) {
                        summary += ` Enfocar la estrategia en mejorar **${firstBadKpi.name}**.`;
                    }
                    summary += `</li>`;
                }
                if (regularKpis.length > 0) {
                    summary += `<li><strong>Áreas a Monitorear:</strong> ${regularKpis.map(k => {
                        let val = k.kpi.value ?? k.kpi.ventas ?? k.kpi.uop ?? '';
                        let unit = k.kpi.unit || '';
                        if (typeof val === 'number' && k.type && k.type.includes('sector')) val = formatCurrency(val);
                        else if (typeof val === 'number') val = val.toFixed(1);
                        return `**${k.name}** (${val}${unit})`;
                    }).join(', ')}. Estos KPIs están cerca de la meta pero necesitan seguimiento constante para asegurar su mejora.</li>`;
                }
                
                summary += `<li><strong>Recomendación General:</strong> Mantener el impulso en las áreas de fortaleza y asignar recursos prioritarios a las áreas de oportunidad. Considerar revisar los procesos y estrategias de venta para los sectores o KPIs con bajo rendimiento.</li>`;
                summary += `</ul>`;

                contentDiv.innerHTML = summary;
                btn.disabled = false;
                btn.innerHTML = `✨ Generar Análisis`;
                lucide.createIcons();
            }, 2000);
        }

        async function handleChatSubmit() { // Made async
            const input = document.getElementById('chat-input');
            const chatHistoryDiv = document.getElementById('chat-history');
            const userMessage = input.value.trim();
            if (!userMessage) return;

            // Add user message to chat
            chatHistoryDiv.innerHTML += `<div class="flex justify-end"><div class="p-3 rounded-lg max-w-sm bg-blue-500 text-white">${userMessage}</div></div>`;
            input.value = '';
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

            // Add thinking indicator
            chatHistoryDiv.innerHTML += `<div id="thinking-bubble" class="flex justify-start"><div class="p-3 rounded-lg bg-gray-200 text-gray-500 animate-pulse">Pensando...</div></div>`;
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

            setTimeout(async () => { // Made inner function async to await getDataForDisplay
                document.getElementById('thinking-bubble').remove();
                
                const lowerCaseInput = userMessage.toLowerCase();
                let queryYear = state.selectedYear;
                let queryMonth = state.selectedMonth;
                let aiResponse = "Lo siento, no pude encontrar información específica sobre eso. Intenta reformular tu pregunta, o pregunta por un KPI, sector o período específico (ej. 'ventas de Construcción en Febrero 2024').";

                // Check for year
                const yearMatch = lowerCaseInput.match(/\b(20\d{2})\b/);
                if (yearMatch) {
                    queryYear = yearMatch[0];
                }

                // Check for month
                const monthMatch = state.months.find(m => lowerCaseInput.includes(m.toLowerCase()));
                if (monthMatch) {
                    queryMonth = monthMatch;
                }
                
                // Get the data for the specified (or default) period, ignoring filters
                const { allKpis: dataForQuery, currentData: rawDataForQuery } = await getDataForDisplay({
                    year: queryYear,
                    month: queryMonth,
                    ignoreFilters: true 
                });
                
                try {
                    // GENERAL QUESTIONS
                    if (lowerCaseInput.includes('hola') || lowerCaseInput.includes('saludos')) {
                        aiResponse = `¡Hola! ¿Cómo puedo ayudarte con los datos de KPIs para ${queryMonth} ${queryYear}?`;
                    } else if (lowerCaseInput.includes('ventas totales')) {
                        const totalSales = Object.values(rawDataForQuery.Ventas).reduce((sum, s) => sum + (s.ventas || 0), 0);
                        aiResponse = `Las ventas totales para ${queryMonth} ${queryYear} fueron de ${formatCurrency(totalSales)}.`;
                    } else if (lowerCaseInput.includes('utilidad total')) {
                        const totalUtility = Object.values(rawDataForQuery.Utilidad).reduce((sum, u) => sum + (u.uop || 0), 0);
                        aiResponse = `La utilidad operativa total para ${queryMonth} ${queryYear} fue de ${formatCurrency(totalUtility)}.`;
                    } else if (lowerCaseInput.includes('resumen del mes') || lowerCaseInput.includes('análisis general')) {
                         const sales = Object.values(rawDataForQuery.Ventas).reduce((sum, s) => sum + (s.ventas || 0), 0);
                         const utility = Object.values(rawDataForQuery.Utilidad).reduce((sum, u) => sum + (u.uop || 0), 0);
                         const csaCoverage = rawDataForQuery['Procesos Internos']['Equipos con CSA']?.value || 0;
                         const nlsScore = rawDataForQuery['Procesos Internos']['NLS Mensual']?.value || 0;
                         aiResponse = `En ${queryMonth} ${queryYear}, las ventas totales fueron ${formatCurrency(sales)} y la utilidad operativa fue ${formatCurrency(utility)}. El porcentaje de equipos con CSA fue del ${csaCoverage.toFixed(1)}% y el NLS mensual de ${nlsScore.toFixed(1)}%.`;
                    }
                    else {
                        // Check for specific KPI mentions including sector or category
                        const foundKpi = dataForQuery.find(k => lowerCaseInput.includes(k.name.toLowerCase()));

                        if (foundKpi) {
                            const { name, kpi } = foundKpi;
                            let displayValue = '';
                            if (kpi.type === 'venta_sector' || kpi.type === 'utilidad_sector') {
                                displayValue = formatCurrency(kpi.ventas || kpi.uop);
                            } else if (kpi.unit === '%') {
                                displayValue = `${(kpi.value || 0).toFixed(1)}%`;
                            } else if (kpi.unit === 'x') {
                                displayValue = `${(kpi.value || 0).toFixed(2)}${kpi.unit}`;
                            } else if (kpi.type === 'inventory') { // Raw inventory has total, >12m, >24m
                                const rawInvData = rawDataForQuery['Inventario']?.[name.replace(/Inv\. > (12|24)m - /, 'Inventario ')];
                                if (rawInvData) {
                                    displayValue = `Total: ${formatCurrency(rawInvData.total || 0)}, >12m: ${formatCurrency(rawInvData.mayor_12_meses || 0)}, >24m: ${formatCurrency(rawInvData.mayor_24_meses || 0)}`;
                                } else {
                                     displayValue = `${(kpi.value || 0).toFixed(1)}${kpi.unit || ''}`;
                                }
                            } else if (kpi.type === 'csa_raw') {
                                displayValue = `${(kpi.unidades_con_csa || 0).toFixed(0)} de ${(kpi.unidades_totales_cat_sem || 0).toFixed(0)} unidades (${((kpi.unidades_con_csa || 0) / (kpi.unidades_totales_cat_sem || 1) * 100).toFixed(1)}%)`;
                            } else if (kpi.type === 'nls_raw') {
                                displayValue = `${(kpi.leales || 0).toFixed(0)} leales, ${(kpi.riesgo || 0).toFixed(0)} en riesgo de ${(kpi.encuestas_totales || 0).toFixed(0)} encuestas.`;
                            } else {
                                 displayValue = `${(kpi.value || 0).toFixed(1)}${kpi.unit || ''}`;
                            }
                            aiResponse = `Para "${name}" en ${queryMonth} ${queryYear}, el valor fue: ${displayValue}. Estado: ${getKPIStatus(kpi)}.`;
                        }
                    }
                } catch (e) {
                    console.error("Error in chat logic:", e);
                    aiResponse = "Tuve un problema al procesar tu pregunta con los datos actuales. Asegúrate de que los datos estén cargados.";
                }
                
                chatHistoryDiv.innerHTML += `<div class="flex justify-start"><div class="p-3 rounded-lg max-w-sm bg-gray-200 text-gray-800">${aiResponse}</div></div>`;
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            }, 1500);
        }

        // ========================================================================
        // MODAL & DATA MANAGEMENT
        // ========================================================================
        
        async function openManagementModal() { // Made async
            modalYearSelect.value = state.selectedYear;
            modalMonthSelect.value = state.selectedMonth;
            await populateModalForm(state.selectedYear, state.selectedMonth); // Await populateForm
            managementModal.showModal();
        }
        
        async function populateModalForm(year, month) { // Made async
            // Fetch the raw data for the selected month/year directly from Firestore (or use the already loaded one)
            const dateKey = `${year}-${month}`;
            let dataToEdit = JSON.parse(JSON.stringify(getInitialMonthData())); // Start with a clean template

            try {
                const docRef = firebase_doc(db, 'kpis_por_mes', dateKey);
                const docSnap = await firebase_getDoc(docRef);

                if (docSnap.exists()) {
                    // Merge fetched data into the template, but only for the 'raw' parts
                    const fetchedData = docSnap.data();
                    Object.keys(dataToEdit).forEach(category => {
                        if (fetchedData[category]) {
                            dataToEdit[category] = dataToEdit[category] || {}; // Ensure category exists in template
                            Object.keys(dataToEdit[category]).forEach(kpiName => {
                                if (fetchedData[category][kpiName]) {
                                    dataToEdit[category][kpiName] = dataToEdit[category][kpiName] || {}; // Ensure KPI exists in template
                                    Object.assign(dataToEdit[category][kpiName], fetchedData[category][kpiName]);
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.error("Error loading data for modal:", error);
                // alert("Error al cargar datos para el modal de administración."); // Commented to avoid multiple alerts
            }

            modalFormContent.innerHTML = '';
            // Categories to display in the modal for direct editing
            // Note: 'Clientes Nuevos' is purely calculated, so it's not in this list for editing.
            const categoriesToDisplayInModal = ['Procesos Internos', 'Inventario', 'Participación', 'Ventas', 'Utilidad', 'Cobertura', 'Datos de Origen'];

            Object.entries(dataToEdit).forEach(([category, kpis]) => {
                if(!categoriesToDisplayInModal.includes(category)) return; // Skip categories not meant for direct editing

                // Filter KPIs within 'Inventario' to show only raw inputs and rotation (not derived percentages)
                let kpisForModal = Object.entries(kpis);
                // if (category === 'Inventario') {
                //     kpisForModal = kpisForModal.filter(([kpiName, kpiData]) => kpiData.type === 'inventory' || kpiData.type === 'rotacion');
                // }
                
                // Filter KPIs within 'Procesos Internos' to show only direct inputs
                if (category === 'Procesos Internos') {
                    // Exclude KPIs whose raw data are in 'Datos de Origen'
                    kpisForModal = kpisForModal.filter(([kpiName, kpiData]) => !['Equipos con CSA', 'NLS Mensual', 'NLS Rolling 6'].includes(kpiName));
                }

                const categoryHtml = `
                    <div>
                        <h4 class="font-semibold text-lg mb-2 border-b pb-2">${category}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${kpisForModal.map(([kpiName, kpiData]) => {
                                // For 'Inventario' category, special handling to show raw data inputs
                                if (category === 'Inventario' && kpiData.type === 'inventory') {
                                    return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-total" class="capitalize text-sm text-gray-100">Total</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-total" type="number" step="any" value="${kpiData.total || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_12_meses" class="capitalize text-sm text-gray-100">Mayor 12 Meses</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_12_meses" type="number" step="any" value="${kpiData.mayor_12_meses || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_24_meses" class="capitalize text-sm text-gray-100">Mayor 24 Meses</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_24_meses" type="number" step="any" value="${kpiData.mayor_24_meses || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (category === 'Datos de Origen' && kpiData.type === 'csa_raw') {
                                    return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_con_csa" class="capitalize text-sm text-gray-100">Unidades Con CSA</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_con_csa" type="number" step="any" value="${kpiData.unidades_con_csa || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_totales_cat_sem" class="capitalize text-sm text-gray-100">Unidades Totales CAT Sem.</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_totales_cat_sem" type="number" step="any" value="${kpiData.unidades_totales_cat_sem || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (category === 'Datos de Origen' && kpiData.type === 'nls_raw') {
                                    return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-leales" class="capitalize text-sm text-gray-100">Leales</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-leales" type="number" step="any" value="${kpiData.leales || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-riesgo" class="capitalize text-sm text-gray-100">Riesgo</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-riesgo" type="number" step="any" value="${kpiData.riesgo || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-encuestas_totales" class="capitalize text-sm text-gray-100">Encuestas Totales</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-encuestas_totales" type="number" step="any" value="${kpiData.encuestas_totales || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (category === 'Ventas' && kpiData.type === 'venta_sector') {
                                     return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas" class="capitalize text-sm text-gray-100">Ventas</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas" type="number" step="any" value="${kpiData.ventas || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas_nuevas" class="capitalize text-sm text-gray-100">Ventas Nuevas</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas_nuevas" type="number" step="any" value="${kpiData.ventas_nuevas || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" class="capitalize text-sm text-gray-100">Meta</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" type="number" step="any" value="${kpiData.meta || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (kpiData.type === 'utilidad_sector') {
                                    return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-uop" class="capitalize text-sm text-gray-100">UOP</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-uop" type="number" step="any" value="${kpiData.uop || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" class="capitalize text-sm text-gray-100">Meta</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" type="number" step="any" value="${kpiData.meta || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (kpiData.type === 'market_share') {
                                     return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-matra" class="capitalize text-sm text-gray-100">Matra</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-matra" type="number" step="any" value="${kpiData.matra || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-industria" class="capitalize text-sm text-gray-100">Industria</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-industria" type="number" step="any" value="${kpiData.industria || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" class="capitalize text-sm text-gray-100">Meta</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" type="number" step="any" value="${kpiData.meta || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                                else { // Default case for KPIs with 'value' and 'meta'
                                    return `
                                        <div style="background-color: #bb8fce;" class="border border-gray-300 p-4 rounded-lg">
                                            <p class="font-medium text-sm mb-3 text-white">${kpiName}</p>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-value" class="capitalize text-sm text-gray-100">Valor</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-value" type="number" step="any" value="${kpiData.value || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <label for="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" class="capitalize text-sm text-gray-100">Meta</label>
                                                    <input data-form-input="true" id="modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta" type="number" step="any" value="${kpiData.meta || 0}" class="w-1/2 block px-3 py-1 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
                modalFormContent.innerHTML += categoryHtml;
            });

            // Add Enter key navigation
            const inputs = modalFormContent.querySelectorAll('input[data-form-input="true"]');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            modalSaveBtn.focus();
                        }
                    }
                });
            });
        }
        
        async function saveModalChanges() { // Made async
            const year = modalYearSelect.value;
            const month = modalMonthSelect.value;
            const dateKey = `${year}-${month}`;

            // Start with the current raw data for the month to preserve untouched fields
            // Fetch it again to ensure it's the absolute latest from Firestore before updating
            const currentDocRef = firebase_doc(db, 'kpis_por_mes', dateKey);
            const currentDocSnap = await firebase_getDoc(currentDocRef);
            let rawDataToSave = currentDocSnap.exists() ? currentDocSnap.data() : JSON.parse(JSON.stringify(getInitialMonthData()));


            // Define categories that contain directly editable fields in the modal
            const categoriesWithDirectInputs = ['Procesos Internos', 'Inventario', 'Participación', 'Ventas', 'Utilidad', 'Cobertura', 'Datos de Origen'];

            // Loop through the relevant categories and update rawDataToSave from form inputs
            categoriesWithDirectInputs.forEach(category => {
                if (rawDataToSave[category]) {
                    Object.entries(rawDataToSave[category]).forEach(([kpiName, kpiData]) => {
                        // Check for specific KPI types that have multiple input fields
                        if (kpiData.type === 'inventory') {
                            const totalInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-total`);
                            const mayor12Input = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_12_meses`);
                            const mayor24Input = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-mayor_24_meses`);
                            if (totalInput) rawDataToSave[category][kpiName].total = parseFloat(totalInput.value) || 0;
                            if (mayor12Input) rawDataToSave[category][kpiName].mayor_12_meses = parseFloat(mayor12Input.value) || 0;
                            if (mayor24Input) rawDataToSave[category][kpiName].mayor_24_meses = parseFloat(mayor24Input.value) || 0;
                        } else if (kpiData.type === 'csa_raw') {
                            const unidadesConCsaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_con_csa`);
                            const unidadesTotalesCatSemInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-unidades_totales_cat_sem`);
                            if (unidadesConCsaInput) rawDataToSave[category][kpiName].unidades_con_csa = parseFloat(unidadesConCsaInput.value) || 0;
                            if (unidadesTotalesCatSemInput) rawDataToSave[category][kpiName].unidades_totales_cat_sem = parseFloat(unidadesTotalesCatSemInput.value) || 0;
                        } else if (kpiData.type === 'nls_raw') {
                            const lealesInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-leales`);
                            const riesgoInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-riesgo`);
                            const encuestasTotalesInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-encuestas_totales`);
                            if (lealesInput) rawDataToSave[category][kpiName].leales = parseFloat(lealesInput.value) || 0;
                            if (riesgoInput) rawDataToSave[category][kpiName].riesgo = parseFloat(riesgoInput.value) || 0;
                            if (encuestasTotalesInput) rawDataToSave[category][kpiName].encuestas_totales = parseFloat(encuestasTotalesInput.value) || 0;
                        } else if (kpiData.type === 'venta_sector') {
                            const ventasInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas`);
                            const ventasNuevasInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-ventas_nuevas`);
                            const metaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta`);
                            if (ventasInput) rawDataToSave[category][kpiName].ventas = parseFloat(ventasInput.value) || 0;
                            if (ventasNuevasInput) rawDataToSave[category][kpiName].ventas_nuevas = parseFloat(ventasNuevasInput.value) || 0;
                            if (metaInput) rawDataToSave[category][kpiName].meta = parseFloat(metaInput.value) || 0;
                        } else if (kpiData.type === 'utilidad_sector') {
                            const uopInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-uop`);
                            const metaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta`);
                            if (uopInput) rawDataToSave[category][kpiName].uop = parseFloat(uopInput.value) || 0;
                            if (metaInput) rawDataToSave[category][kpiName].meta = parseFloat(metaInput.value) || 0;
                        } else if (kpiData.type === 'market_share') {
                            const matraInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-matra`);
                            const industriaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-industria`);
                            const metaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta`);
                            if (matraInput) rawDataToSave[category][kpiName].matra = parseFloat(matraInput.value) || 0;
                            if (industriaInput) rawDataToSave[category][kpiName].industria = parseFloat(industriaInput.value) || 0;
                            if (metaInput) rawDataToSave[category][kpiName].meta = parseFloat(metaInput.value) || 0;
                        }
                        else { // Default case for KPIs with 'value' and 'meta' fields directly
                            const valueInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-value`);
                            const metaInput = document.getElementById(`modal-${category.replace(/\s/g,'-')}-${kpiName.replace(/\s/g,'-')}-meta`);
                            if (valueInput) rawDataToSave[category][kpiName].value = parseFloat(valueInput.value) || 0;
                            if (metaInput) rawDataToSave[category][kpiName].meta = parseFloat(metaInput.value) || 0;
                        }
                    });
                }
            });

            try {
                // Save the updated raw data to Firestore
                await firebase_setDoc(firebase_doc(db, 'kpis_por_mes', dateKey), rawDataToSave);
                alert('¡Datos guardados exitosamente en la nube!');
                console.log("Document successfully written!");

                // Update local state AFTER successful save to cloud (this also re-calculates derived KPIs)
                state.kpiDataByDate[year] = state.kpiDataByDate[year] || {};
                state.kpiDataByDate[year][month] = rawDataToSave; // Store the raw data back

                state.selectedYear = year;
                state.selectedMonth = month;
                yearSelect.value = year;
                monthSelect.value = month;

                managementModal.close();
                await renderDashboard(); // Re-render the dashboard with the new data
            } catch (error) {
                console.error("Error writing document: ", error);
                alert('Hubo un error al guardar los datos. Revisa la consola (F12) para más detalles.');
            }
        }

        function getMonthSequence(endYearStr, endMonthStr, count) {
            const sequence = [];
            let currentYear = parseInt(endYearStr);
            let currentMonthIndex = state.months.indexOf(endMonthStr);

            for(let i=0; i< count; i++) {
                sequence.unshift({ year: String(currentYear), month: state.months[currentMonthIndex]});
                currentMonthIndex--;
                if (currentMonthIndex < 0) {
                    currentMonthIndex = 11;
                    currentYear--;
                }
            }
            return sequence;
        }

        async function handleExport() { // Made async
            const { allKpis } = await getDataForDisplay({ignoreFilters: true}); // Await all data before export
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Category,KPI,Status,Value,Meta\n";

            allKpis.forEach(({ category, name, kpi }) => {
                const status = getKPIStatus(kpi);
                let value;
                if (kpi.type === 'venta_sector') value = kpi.ventas || 0;
                else if (kpi.type === 'utilidad_sector') value = kpi.uop || 0;
                else if (kpi.type === 'market_share') value = (kpi.industria || 0) > 0 ? ((kpi.matra || 0) / kpi.industria) * 100 : 0;
                else value = kpi.value || 0; // For percentage, ratio, rotacion, csa, nls, etc.
                
                // Add specific values for export formatting
                if (kpi.type === 'inventory_percentage') { // These are calculated percentages for display, not raw.
                    // If you wanted to export the raw inventory numbers, you'd need to access `state.kpiDataByDate`
                    // and then the specific raw `inventory` KPI for this month/year.
                    value = `${(kpi.value || 0).toFixed(1)}%`;
                } else if (kpi.type === 'csa_percentage') {
                    value = `${(kpi.value || 0).toFixed(1)}%`;
                } else if (kpi.type === 'nls_percentage') {
                    value = `${(kpi.value || 0).toFixed(1)}%`;
                } else if (kpi.type === 'new_client_percentage') {
                    value = `${(kpi.value || 0).toFixed(1)}%`;
                } else if (kpi.type === 'cobertura_percentage') {
                     value = `${(kpi.value || 0).toFixed(1)}%`;
                } else if (kpi.type === 'rotacion') {
                    value = `${(kpi.value || 0).toFixed(2)}${kpi.unit}`;
                } else if (kpi.type === 'venta_sector') {
                    value = `${(kpi.ventas || 0)}`; // Export raw number, not formatted currency
                } else if (kpi.type === 'utilidad_sector') {
                    value = `${(kpi.uop || 0)}`; // Export raw number
                }


                const row = [category, `"${name}"`, status, value, kpi.meta || ''].join(','); // Ensure meta is exported, use empty string if undefined
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `kpi_export_${state.selectedMonth}_${state.selectedYear}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }


        // ========================================================================
        // INITIALIZATION & EVENT LISTENERS
        // ========================================================================
        async function initDashboard() { // Made async
            // Populate selectors
            yearSelect.innerHTML = state.years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.innerHTML = state.months.map(m => `<option value="${m}">${m}</option>`).join('');
            sectorSelect.innerHTML = `<option value="todos">Todos los Sectores</option>` + state.sectors.map(s => `<option value="${s}">${s}</option>`).join('');
            modalYearSelect.innerHTML = yearSelect.innerHTML;
            modalMonthSelect.innerHTML = monthSelect.innerHTML;

            // Set initial selector values
            yearSelect.value = state.selectedYear;
            monthSelect.value = state.selectedMonth;
            sectorSelect.value = state.selectedSector;
            statusFilterSelect.value = state.filterStatus;

            // Initial render
            await renderDashboard(); // Await the initial dashboard render

            // Event Listeners
            yearSelect.addEventListener('change', async (e) => { state.selectedYear = e.target.value; await renderDashboard(); });
            monthSelect.addEventListener('change', async (e) => { state.selectedMonth = e.target.value; await renderDashboard(); });
            sectorSelect.addEventListener('change', async (e) => { state.selectedSector = e.target.value; await renderDashboard(); });
            statusFilterSelect.addEventListener('change', async (e) => { state.filterStatus = e.target.value; await renderDashboard(); });
            
            tabsList.addEventListener('click', async (e) => { // Made async
                if (e.target.tagName === 'BUTTON') {
                    state.selectedCategory = e.target.dataset.tab;
                    await renderDashboard();
                }
            });
            
            tabsContent.addEventListener('click', (e) => {
                const trigger = e.target.closest('.collapsible-trigger');
                if (trigger) {
                    const content = trigger.nextElementSibling;
                    const icon = trigger.querySelector('[data-lucide="chevron-down"], [data-lucide="chevron-up"]');
                    content.classList.toggle('open');
                    if (content.classList.contains('open')) {
                        icon.setAttribute('data-lucide', 'chevron-up');
                    } else {
                        icon.setAttribute('data-lucide', 'chevron-down');
                    }
                    lucide.createIcons();
                }
            });

            manageBtn.addEventListener('click', openManagementModal);
            logoutBtn.addEventListener('click', handleLogout);
            modalCloseBtn.addEventListener('click', () => managementModal.close());
            modalCancelBtn.addEventListener('click', () => managementModal.close());
            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalYearSelect.addEventListener('change', async (e) => await populateModalForm(e.target.value, modalMonthSelect.value)); // Made async
            modalMonthSelect.addEventListener('change', async (e) => await populateModalForm(modalYearSelect.value, e.target.value)); // Made async
            exportBtn.addEventListener('click', handleExport);
        }

        // Setup login page on initial load
        setupLoginPage();
        loginForm.addEventListener('submit', handleLogin);
        togglePasswordBtn.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordBtn.innerHTML = type === 'password' ? '<i data-lucide="eye" class="w-5 h-5"></i>' : '<i data-lucide="eye-off" class="w-5 h-5"></i>';
            lucide.createIcons();
        });
    });
    </script>
</body>
</html>