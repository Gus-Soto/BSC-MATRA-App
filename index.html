<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de KPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.368.0/lucide.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Slate 200 */
            color: #111827;
        }
        #login-page {
            background: url('https://images.unsplash.com/photo-1529369627985-2d9bcf543ea8?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
        }
        .login-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.5rem; transition: background-color 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: #facc15; color: #111827; font-weight: 700; }
        .btn-primary:hover { background-color: #eab308; }
        .btn-secondary { background-color: white; color: #374151; border-color: #d1d5db; }
        .btn-secondary:hover { background-color: #f3f4f6; }
        .tabs-list button.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        dialog { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); padding: 0; width: 90%; max-width: 50rem; }
        dialog::backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-in-out; }
        .collapsible-content.open { max-height: 1500px; }
        .prose { line-height: 1.7; }
        .prose strong { font-weight: 600; }
        .prose ul { list-style-position: inside; padding-left: 0.5rem; }
        .prose li::marker { content: '•'; color: #4b5563; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .tabs-list::-webkit-scrollbar { height: 4px; }
        .tabs-list::-webkit-scrollbar-track { background: #e2e8f0; }
        .tabs-list::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
        .tabs-list::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>

    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="login-overlay absolute inset-0"></div>
        <div class="relative w-full max-w-md p-8 space-y-6 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg">
            <div id="login-greeting" class="text-center"></div>
            <form id="login-form" class="space-y-6 mt-8">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-300">Usuario (Email)</label>
                    <input id="username" name="username" type="email" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-300">Contraseña</label>
                    <div class="relative">
                        <input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-400 hidden">Usuario o contraseña incorrectos.</p>
                <div>
                    <button type="submit" class="w-full btn btn-primary">Iniciar Sesión</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dashboard-page" class="hidden max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="pb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Dashboard de KPIs</h1>
                    <p id="dashboard-subtitle" class="mt-1 text-gray-500">Cargando datos...</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <select id="year-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <select id="month-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <select id="sector-select" class="block w-full sm:w-auto px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                    <button id="manage-btn" class="btn btn-secondary"><i data-lucide="settings" class="w-4 h-4 mr-2"></i>Administrar</button>
                    <button id="export-btn" class="btn btn-secondary"><i data-lucide="download" class="w-4 h-4 mr-2"></i>Exportar</button>
                    <button id="logout-btn" class="btn btn-secondary"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i>Cerrar Sesión</button>
                </div>
            </div>
        </header>
        <main>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div id="tabs-list" class="tabs-list flex flex-nowrap space-x-1 border-b border-gray-200 overflow-x-auto w-full pb-1"></div>
                <div class="flex items-center space-x-2 mt-4 sm:mt-0 w-full sm:w-auto sm:max-w-xs flex-shrink-0">
                    <i data-lucide="filter" class="w-4 h-4 text-gray-500"></i>
                    <select id="status-filter-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                        <option value="todos">Todos los Estados</option>
                        <option value="Bueno">Filtrar por "Bueno"</option>
                        <option value="Regular">Filtrar por "Regular"</option>
                        <option value="Malo">Filtrar por "Malo"</option>
                    </select>
                </div>
            </div>
            <div id="tabs-content" class="mt-6">
                 <div class="text-center py-12 card animate-pulse">
                    <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-gray-400 animate-spin"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Cargando Datos...</h3>
                    <p class="mt-1 text-sm text-gray-500">Obteniendo la información más reciente desde la base de datos.</p>
                </div>
            </div>
        </main>
    </div>

    <dialog id="management-modal">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Administrar Datos de KPIs</h2>
                    <p class="text-sm text-gray-500 mt-1">Actualice los valores para el período seleccionado.</p>
                </div>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex gap-4 mb-4">
                <select id="modal-year-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
                <select id="modal-month-select" class="block w-full px-3 py-2 text-sm border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"></select>
            </div>
            <div id="modal-form-content" class="max-h-[60vh] overflow-y-auto pr-2 space-y-6"></div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="modal-save-btn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </dialog>
    
    <template id="kpi-card-template">
        <div class="card flex flex-col">
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-start">
                    <h3 class="kpi-title text-base font-medium max-w-[70%]"></h3>
                    <div class="text-right">
                        <div class="kpi-achievement"></div>
                        <span class="kpi-status-badge mt-1 inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full"></span>
                    </div>
                </div>
            </div>
            <div class="p-4 md:p-6 pt-0">
                <div class="kpi-value text-3xl font-bold"></div>
                <div class="kpi-meta text-sm text-gray-500 mt-1"></div>
                <div class="kpi-trend mt-2 text-xs flex items-center"></div>
            </div>
            <div class="kpi-chart-container mt-auto p-4 md:p-6 pt-0">
                <div class="text-xs text-gray-500 mb-1">Tendencia (Últimos 12 meses)</div>
                <div style="height: 60px;"><canvas class="kpi-sparkline-chart"></canvas></div>
            </div>
        </div>
    </template>
    
    <script>
    // ========================================================================
    // FIREBASE INITIALIZATION
    // ========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAt_2O9DN5qblHUaDnlKFkDKP270TezY6g",
        authDomain: "bsc-matra-app.firebaseapp.com",
        projectId: "bsc-matra-app",
        storageBucket: "bsc-matra-app.firebasestorage.app",
        messagingSenderId: "742996450855",
        appId: "1:742996450855:web:286a28f6acc3d61f63f802"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ========================================================================
    // INITIALIZATION & GLOBAL STATE
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        // User permissions (now simplified, could be moved to Firestore rules or user claims)
        const userPermissions = {
            "estelavillalobos@matra.com": { level: "write", firstName: "Estela" },
            "hugovargas@matra.com": { level: "read", firstName: "Hugo" },
            "carloscalderon@matra.com": { level: "read", firstName: "Carlos" },
            "gustavosoto@matra.com": { level: "read", firstName: "Gustavo" },
            "franciscoramirez@matra.com": { level: "read", firstName: "Francisco" }
        };
        
        const motivationalQuotes = ["El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "Cree en ti mismo y todo lo que eres.", "El único lugar donde el éxito viene antes que el trabajo es en el diccionario.", "No esperes. El momento nunca será el adecuado.", "La mejor manera de predecir el futuro es crearlo.", "Tu único límite es tu mente."];

        const state = {
            currentUser: null,
            userProfile: null, // To store user's first name and level
            years: ['2025', '2024'],
            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            sectors: ['Agrícola', 'Construcción', 'Distribución', 'Gobierno', 'Heavy Rent'],
            selectedYear: '2025',
            selectedMonth: 'Junio',
            selectedCategory: 'dashboard',
            filterStatus: 'todos',
            selectedSector: 'todos',
            kpiDataByDate: {}, // This will now act as a cache
            charts: {},
            isDataLoading: true,
        };

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginGreeting = document.getElementById('login-greeting');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const sectorSelect = document.getElementById('sector-select');
        const statusFilterSelect = document.getElementById('status-filter-select');
        const tabsList = document.getElementById('tabs-list');
        const tabsContent = document.getElementById('tabs-content');
        const dashboardSubtitle = document.getElementById('dashboard-subtitle');
        const manageBtn = document.getElementById('manage-btn');
        const exportBtn = document.getElementById('export-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const managementModal = document.getElementById('management-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalYearSelect = document.getElementById('modal-year-select');
        const modalMonthSelect = document.getElementById('modal-month-select');
        const modalFormContent = document.getElementById('modal-form-content');
        
        // ========================================================================
        // HELPER & UTILITY FUNCTIONS
        // ========================================================================

        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value || 0);
        
        const getInitialMonthData = () => ({
            'Procesos Internos': { 'Satisfacción Entrega de Equipos': { value: 0, meta: 90, unit: '%', type: 'percentage' }, 'Costo de Alisto BCP': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, 'Costo de Alisto CAT': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, 'Costo de Alisto JD': { value: 0, meta: 1, unit: '', type: 'ratio', inverted: true }, },
            'Inventario': { 'Rotación Caterpillar': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación John Deere': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación International': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación Mack': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación Volvo': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación Metso': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Rotación Otras Marcas': { value: 0, meta: 2, unit: 'x', type: 'rotacion' }, 'Inventario Caterpillar Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Caterpillar Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario John Deere Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario John Deere Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario International Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario International Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Mack Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Mack Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Volvo Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Volvo Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Metso Nuevo': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, 'Inventario Metso Usado': { total: 0, mayor_12_meses: 0, mayor_24_meses: 0, type: 'inventory' }, },
            'Participación': { 'Participación Caterpillar PINS': { matra: 0, industria: 0, meta: 30, unit: '%', type: 'market_share' }, 'Participación John Deere': { matra: 0, industria: 0, meta: 25, unit: '%', type: 'market_share' }, 'Participación Mack Clase 8': { matra: 0, industria: 0, meta: 20, unit: '%', type: 'market_share' }, 'Participación International': { matra: 0, industria: 0, meta: 18, unit: '%', type: 'market_share' }, },
            'Ventas': { 'Agrícola': { ventas: 0, ventas_nuevas: 0, meta: 280000, type: 'venta_sector' }, 'Construcción': { ventas: 0, ventas_nuevas: 0, meta: 420000, type: 'venta_sector' }, 'Distribución': { ventas: 0, ventas_nuevas: 0, meta: 150000, type: 'venta_sector' }, 'Gobierno': { ventas: 0, ventas_nuevas: 0, meta: 75000, type: 'venta_sector' }, 'Heavy Rent': { ventas: 0, ventas_nuevas: 0, meta: 60000, type: 'venta_sector' }, },
            'Utilidad': { 'Agrícola': { uop: 0, meta: 28000, type: 'utilidad_sector' }, 'Construcción': { uop: 0, meta: 45000, type: 'utilidad_sector' }, 'Distribución': { uop: 0, meta: 18000, type: 'utilidad_sector' }, 'Gobierno': { uop: 0, meta: 8000, type: 'utilidad_sector' }, 'Heavy Rent': { uop: 0, meta: 7500, type: 'utilidad_sector' }, },
            'Cobertura': { 'Cobertura Construcción': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Agrícola': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Distribución': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' }, 'Cobertura Gobierno': { value: 0, meta: 90, unit: '%', type: 'cobertura_percentage' } },
            'Datos de Origen': { 'Equipos con CSA': { unidades_con_csa: 0, unidades_totales_cat_sem: 0, type: 'csa_raw' }, 'NLS Mensual': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' }, 'NLS Rolling 6': { leales: 0, riesgo: 0, encuestas_totales: 0, type: 'nls_raw' } }
        });

        const getKPIStatus = (kpi) => { /* ... (Function remains unchanged) ... */ };
        const getStatusStyles = (status) => { /* ... (Function remains unchanged) ... */ };

        // ========================================================================
        // DATA HANDLING & PREPARATION (with Firestore)
        // ========================================================================
        
        async function fetchKpiDataForPeriod(year, month) {
            const docId = `${year}-${month}`;
            const cacheKey = `${year}-${month}`;

            // Return cached data if available
            if (state.kpiDataByDate[cacheKey]) {
                return state.kpiDataByDate[cacheKey];
            }

            try {
                const docRef = db.collection('kpi_data').doc(year).collection('months').doc(month);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const data = docSnap.data();
                    state.kpiDataByDate[cacheKey] = data; // Cache the data
                    return data;
                } else {
                    console.log(`No data for ${month} ${year}, returning initial structure.`);
                    // If no data exists, return the default structure but don't cache it
                    // as it might be created and saved later.
                    return getInitialMonthData();
                }
            } catch (error) {
                console.error("Error fetching KPI data:", error);
                // Return default structure on error to prevent app crash
                return getInitialMonthData();
            }
        }

        const getPreviousMonth = (year, month) => { /* ... (Function remains unchanged) ... */ };

        async function getDataForDisplay(options = {}) {
            const { year, month, ignoreFilters } = options;
            const queryYear = year || state.selectedYear;
            const queryMonth = month || state.selectedMonth;

            const currentData = await fetchKpiDataForPeriod(queryYear, queryMonth);
            
            // The rest of the data processing logic remains largely the same
            // as it operates on the `currentData` object.
            
            // --- Dynamically create calculated KPIs ---
            const newClientsKpis = {};
            // ... (rest of the data processing logic from your original file)
            
            // This part is complex and remains the same. It just needs `currentData`
            // which is now fetched from Firestore.
            
            // --- Return the processed data ---
            return { /* ... (same return structure) ... */ };
        }

        // ========================================================================
        // AUTHENTICATION (with Firebase Auth)
        // ========================================================================

        function handleLogin(event) {
            event.preventDefault();
            const email = usernameInput.value;
            const password = passwordInput.value;
            const submitButton = loginForm.querySelector('button[type="submit"]');

            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="animate-pulse">Iniciando...</span>`;
            loginError.classList.add('hidden');

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    // The onAuthStateChanged observer will handle the UI transition
                })
                .catch((error) => {
                    loginError.textContent = "Usuario o contraseña incorrectos.";
                    loginError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Iniciar Sesión';
                });
        }

        function handleLogout() {
            auth.signOut();
        }
        
        function setupLoginPage() {
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            const greetingHtml = `
                <p class="mt-2 text-lg text-gray-200">Dashboard de Ventas - Balanced Scorecard<br>Ingrese para continuar.</p>
                <p class="mt-4 text-sm text-yellow-400 italic">"${randomQuote}"</p>`;
            loginGreeting.innerHTML = greetingHtml;
        }

        // Firebase Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in.
                state.currentUser = user;
                state.userProfile = userPermissions[user.email] || { level: 'read', firstName: 'Usuario' };

                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                
                if (!state.kpiDataByDate[`${state.selectedYear}-${state.selectedMonth}`]) {
                    await initDashboard();
                }

            } else {
                // User is signed out.
                state.currentUser = null;
                state.userProfile = null;
                dashboardPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                setupLoginPage();
                loginForm.reset();
            }
        });

        // ========================================================================
        // RENDERING & UI UPDATES
        // ========================================================================

        function destroyAllCharts() { /* ... (Function remains unchanged) ... */ }

        async function renderDashboard() {
            state.isDataLoading = true;
            setLoadingState(true);
            destroyAllCharts();

            dashboardSubtitle.textContent = `Mostrando datos para ${state.selectedMonth} ${state.selectedYear}.`;
            manageBtn.style.display = (state.userProfile?.level === 'write') ? 'inline-flex' : 'none';

            // Fetch all necessary data for the current view before rendering
            await prefetchAllDataForView();

            renderTabs();
            renderTabContent(); // This will now use the cached data
            
            state.isDataLoading = false;
            setLoadingState(false);
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                tabsContent.innerHTML = `
                 <div class="text-center py-12 card animate-pulse">
                    <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-gray-400 animate-spin"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Cargando Datos...</h3>
                    <p class="mt-1 text-sm text-gray-500">Obteniendo la información más reciente desde la base de datos.</p>
                </div>`;
                lucide.createIcons();
            }
        }
        
        async function prefetchAllDataForView() {
            const sequence = getMonthSequence(state.selectedYear, state.selectedMonth, 12);
            const fetchPromises = sequence.map(({ year, month }) => fetchKpiDataForPeriod(year, month));
            await Promise.all(fetchPromises);
        }
        
        // ... ALL OTHER RENDER* functions (renderTabs, renderTabContent, etc.) remain the same
        // They will now read from `state.kpiDataByDate` which acts as a cache.

        // ========================================================================
        // MODAL & DATA MANAGEMENT (with Firestore)
        // ========================================================================

        async function openManagementModal() {
            modalYearSelect.value = state.selectedYear;
            modalMonthSelect.value = state.selectedMonth;
            await populateModalForm(state.selectedYear, state.selectedMonth);
            managementModal.showModal();
        }

        async function populateModalForm(year, month) {
            modalFormContent.innerHTML = `<div class="animate-pulse text-center">Cargando formulario...</div>`;
            const dataToEdit = await fetchKpiDataForPeriod(year, month);
            modalFormContent.innerHTML = ''; // Clear loading
            
            // ... The rest of the function that builds the form HTML remains the same
            // It will use the `dataToEdit` fetched from firestore.
        }

        async function saveModalChanges() {
            modalSaveBtn.disabled = true;
            modalSaveBtn.innerHTML = `<span class="animate-pulse">Guardando...</span>`;

            const year = modalYearSelect.value;
            const month = modalMonthSelect.value;
            const dataToSave = getInitialMonthData(); // Start with a clean structure
            
            // This logic is complex and remains the same as your original.
            // It correctly reads from the form inputs and structures the object.
            Object.entries(dataToSave).forEach(([category, kpis]) => {
                 // ... (Iterate through inputs and populate dataToSave) ...
            });

            try {
                const docRef = db.collection('kpi_data').doc(year).collection('months').doc(month);
                await docRef.set(dataToSave, { merge: true }); // Use set with merge to create or update

                // Invalidate cache for the saved data
                delete state.kpiDataByDate[`${year}-${month}`];

                state.selectedYear = year;
                state.selectedMonth = month;
                yearSelect.value = year;
                monthSelect.value = month;

                managementModal.close();
                await renderDashboard(); // Re-render with fresh data

            } catch (error) {
                console.error("Error saving data: ", error);
                alert("Hubo un error al guardar los datos. Por favor, inténtelo de nuevo.");
            } finally {
                modalSaveBtn.disabled = false;
                modalSaveBtn.textContent = 'Guardar Cambios';
            }
        }
        
        // ... getMonthSequence and handleExport remain unchanged.
        
        // ========================================================================
        // INITIALIZATION & EVENT LISTENERS
        // ========================================================================
        async function initDashboard() {
            // Populate selectors
            yearSelect.innerHTML = state.years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.innerHTML = state.months.map(m => `<option value="${m}">${m}</option>`).join('');
            sectorSelect.innerHTML = `<option value="todos">Todos los Sectores</option>` + state.sectors.map(s => `<option value="${s}">${s}</option>`).join('');
            modalYearSelect.innerHTML = yearSelect.innerHTML;
            modalMonthSelect.innerHTML = monthSelect.innerHTML;
            
            // Set initial selector values
            yearSelect.value = state.selectedYear;
            monthSelect.value = state.selectedMonth;
            
            await renderDashboard();
            
            // Add Event Listeners (only once)
            yearSelect.onchange = (e) => { state.selectedYear = e.target.value; renderDashboard(); };
            monthSelect.onchange = (e) => { state.selectedMonth = e.target.value; renderDashboard(); };
            sectorSelect.onchange = (e) => { state.selectedSector = e.target.value; renderDashboard(); };
            statusFilterSelect.onchange = (e) => { state.filterStatus = e.target.value; renderDashboard(); };
            tabsList.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') {
                    state.selectedCategory = e.target.dataset.tab;
                    renderTabContent(); // Faster re-render without fetching all data again
                }
            };
            manageBtn.onclick = openManagementModal;
            logoutBtn.onclick = handleLogout;
            modalCloseBtn.onclick = () => managementModal.close();
            modalCancelBtn.onclick = () => managementModal.close();
            modalSaveBtn.onclick = saveModalChanges;
            modalYearSelect.onchange = (e) => populateModalForm(e.target.value, modalMonthSelect.value);
            modalMonthSelect.onchange = (e) => populateModalForm(modalYearSelect.value, e.target.value);
            exportBtn.onclick = handleExport;
        }

        // Login page listeners
        loginForm.addEventListener('submit', handleLogin);
        togglePasswordBtn.addEventListener('click', () => { /* ... (Unchanged) ... */ });
    });
    </script>
</body>
</html>